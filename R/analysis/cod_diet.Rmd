---
title: "Cod diet model"
author: "Max Lindmark & Michele Casini"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---
  
```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro
Fit density (also referred to as CPUE) model with environmental predictors and use that to calculate weighted mean dissolved oxygen, temperature and depth of Baltic cod

```{r lib, message=FALSE}
# Load libraries, install if needed
library(tidyverse); theme_set(theme_light(base_size = 10))
library(readxl)
library(tidylog)
library(RCurl)
library(viridis)
library(RColorBrewer)
library(patchwork)
library(janitor)
library(icesDatras)
library(mapdata)
library(patchwork)
library(rgdal)
library(raster)
library(sf)
library(rgeos)
library(chron)
library(lattice)
library(ncdf4)
library(marmap)
library(rnaturalearth)
library(rnaturalearthdata)
library(mapplots)
library(EnvStats)
library(qwraps2)
#remotes::install_github("pbs-assess/sdmTMB")
library(sdmTMB)# To load entire cache in interactive r session, do: qwraps2::lazyload_cache_dir(path = "R/analysis/spatial_trend_models_cache/html")
```

## For maps

```{r read coastline data, message=FALSE, warning=FALSE}
# Specify map ranges
ymin = 55; ymax = 58; xmin = 14; xmax = 20

map_data <- rnaturalearth::ne_countries(
  scale = "medium",
  returnclass = "sf", continent = "europe")

# Crop the polygon for plotting and efficiency:
# st_bbox(map_data) # find the rough coordinates
swe_coast <- suppressWarnings(suppressMessages(
  st_crop(map_data,
          c(xmin = xmin, ymin = ymin, xmax = xmax, ymax = ymax))))

# Transform our map into UTM 33 coordinates, which is the equal-area projection we fit in:
utm_zone33 <- 32633
swe_coast_proj <- sf::st_transform(swe_coast, crs = utm_zone33)

ggplot(swe_coast_proj) + geom_sf() 

# Define plotting theme for main plot
theme_plot <- function(base_size = 10, base_family = "") {
  theme_light(base_size = 10, base_family = "") +
    theme(
      axis.text.x = element_text(angle = 90),
      axis.text = element_text(size = 8),
      legend.text = element_text(size = 8),
      legend.title = element_text(size = 8),
      legend.position = "bottom",
      legend.key.height = unit(0.2, "cm"),
      legend.margin = margin(0, 0, 0, 0),
      legend.box.margin = margin(-5, -5, -5, -5),
      strip.text = element_text(size = 8, colour = 'black', margin = margin()),
      strip.background = element_rect(fill = "grey90")
      )
}

# Define plotting theme for facet_wrap map with years
theme_facet_map <- function(base_size = 10, base_family = "") {
  theme_light(base_size = 10, base_family = "") +
    theme(
        axis.text.x = element_text(angle = 90),
        axis.text = element_text(size = 6),
        strip.text = element_text(size = 8, colour = 'black', margin = margin()),
        strip.background = element_rect(fill = "grey90")
      )
}

# Make default base map plot
plot_map_raster <- 
ggplot(swe_coast_proj) + 
  geom_sf(size = 0.3) +
  labs(x = "Longitude", y = "Latitude") +
  theme_facet_map(base_size = 14)

# Function to convert from lat lon to UTM
LongLatToUTM <- function(x, y, zone){
  xy <- data.frame(ID = 1:length(x), X = x, Y = y)
  coordinates(xy) <- c("X", "Y")
  proj4string(xy) <- CRS("+proj=longlat +datum=WGS84")  ## for example
  res <- spTransform(xy, CRS(paste("+proj=utm +zone=",zone," ellps=WGS84",sep='')))
  return(as.data.frame(res))
}
```

## Read data

```{r}
d <- readr::read_csv("/Users/maxlindmark/Desktop/R_STUDIO_PROJECTS/bentfish/data/for_analysis/stomach/full_stomach_data_21.10.25.csv") %>% dplyr::select(-X1)

# Add UTM coordinates
utm_coords <- LongLatToUTM(d$Long, d$Lat, zone = 33)
d$X <- utm_coords$X/1000
d$Y <- utm_coords$Y/1000
```

## Explore data

```{r}
head(data.frame(d))
sort(colnames(d))
#  [1] "Age"                    "Comment"                "comments"               "Coun."                 
#  [5] "Cruise"                 "Date"                   "Day"                    "Depth.catch"           
#  [9] "Depthstep"              "Gall.content"           "Gonad.weight.roundfish" "HN"                    
# [13] "Ices.rect"              "Index"                  "Lat"                    "Length.code"           
# [17] "Liver.weight.roundfish" "Long"                   "Maturity"               "Month"                 
# [21] "N.empty"                "N.regurgitated"         "N.skeletal"             "N.with.food"           
# [25] "Number"                 "Parasites.in.stomach"   "Perc.stomac.content"    "Pred.size.mm"          
# [29] "Pred.weight.g"          "Predator.code"          "Predator.gutted.weight" "Prey.nr"               
# [33] "Prey.size"              "Prey.sp.code"           "Prey.weight"            "Processed"             
# [37] "Q.year"                 "Quarter"                "Sample"                 "Sample.type"           
# [41] "Sex"                    "Ship"                   "source"                 "Stage.digestion"       
# [45] "Stomach.content"        "SubDiv"                 "transect"               "Unique.pred.id"        
# [49] "X"

# Plot data in space, color by survey
plot_map_raster +
  geom_point(data = d, aes(x = X * 1000, y = Y * 1000, color = Cruise), size = 0.5) +
  scale_color_brewer(palette = "Set2") + 
  facet_wrap(~ Cruise, ncol = 2) + 
  theme_plot()

# Calculate total weight of prey by predator ID and prey species (i.e., across prey sizes)
d_wide <- d %>% 
  drop_na(Prey.weight) %>% 
  group_by(Unique.pred.id, Prey.sp.code) %>% 
  summarise(tot_biom_per_prey = sum(Prey.weight)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = Prey.sp.code, values_from = tot_biom_per_prey) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # Replace NA with 0
  janitor::clean_names()

head(d_wide)
str(d_wide)
colnames(d_wide)
 
# Now make some calculations and aggregate some taxonomic level
d_wide2 <- d_wide %>% 
  mutate(amphipoda_tot = bylgides_sarsi + hyperia_galba + gammarus_sp + monoporeia_affinis + 
           corophium_volutator + amphipoda,
         bivalvia_tot = bivalvia + mytilus_sp + cerastoderma_glaucum + mya_arenaria + macoma_balthica + 
           mytilus_edulis,
         clupeidae_tot = clupeidae + clupea_harengus_2 + sprattus_sprattus_2 + clupeidae_2,
         sprattus_sprattus_tot = sprattus_sprattus + sprattus_sprattus_2,
         clupea_harengus_tot = clupea_harengus + clupea_harengus_2,
         #gadus_morhua_tot = gadus_morhua,
         gadiformes_tot = gadidae + merlangius_merlangus,
         gobiidae_tot = gobiidae,
         mysidae_tot = mysidae + neomysis_integer + mysis_mixta + mysida + gastrosacus,
         non_bio_tot = stone + plastic + sand + wood + litter + carbon + stone_2 + carbon_2 + wood_2 + 
           litter_plastics + sand_2,
         other_crustacea_tot = pontoporeia_femorata + crangon_crangon + idotea_balthica + 
           praunus_flexuosus + crustacea + diastylis_rathkei + palaemon_sp + palaemon_elegans + caridea +
           amphibalanus_improvisus + palaemonidae + carcinus_maenas + copepoda + calanoida + pontoporeiidae + decapoda, 
         other_tot = halicryptus_spinulosus + priapulus_caudatus + annelida + algae + priapulidae + waste +
           unidentified_mass + spine + empty + mollusca + na + remains + gastropoda + hydrobia_sp + 
           priapulida + halicryptus + digestive_tract + mucus + remains_2 + pontoporeidae +
           halicryptus_spinolusus + priapulida_2 + prapulida,
         other_pisces_tot = enchelyopus_cimbrius + trachurus_trachurus + gasterosteus_aculeatus + 
           scales + pleuronectes_platessa + anguilla_anguilla + pungitius_pungitius + ammodytes_tobianus +
           cottidae + spinachia_spinachia + zoarces_viviparus + ammodytidae + myoxocephalus_quadricornis +
           hyperoplus_lanceolatus + pleuronectiformes + scophthalmus_maximus + neogobius_melanostomus + gobius_niger +
           pleuronectidae + gasterosteidae + belone_belone + agonus_cataphractus + myoxocephalus_scorpius,
         platichthys_flesus_tot = platichthys_flesus,
         polychaeta_tot = bylgides_sarsi + scoloplos_armiger + terebellides_stroemii + hediste_diversicolor + 
           phyllodocida + polychaeta + pectinaria_sp + nephtys_ciliata,
         saduria_entomon_tot = saduria_entomon
         )

length(unique(d$Unique.pred.id))
str(d_wide2) # Check why they do not match in length / nrows

# Select only columns aggregated columns
d_wide3 <- d_wide2 %>% dplyr::select(c(1, 114:128))

colnames(d_wide3)  

# Add back in other information 
d_sub <- d %>%
  dplyr::select(Year, Quarter, Cruise, Predator.code, X, Y, Lat, Long, Ices.rect, Pred.size.mm,
                Pred.weight.g, Unique.pred.id, source) %>% 
  rename("Predator.spec" = "Predator.code") %>% 
  distinct(Unique.pred.id, .keep_all = TRUE) %>%
  janitor::clean_names()  

d_wide4 <- left_join(d_wide3, d_sub) # Why missing 1,121 IDs?

#d_wide4 %>% group_by(unique_pred_id) %>% mutate(n = n()) %>% ungroup() %>% distinct(n)
colnames(d_wide4)
head(data.frame(d_wide4))

colnames(d_wide4)
d_wide4[1, 2]
d_wide4[1, 16]

d_wide4 <- d_wide4 %>% mutate(tot_prey_biom = rowSums(.[2:16]))

# Now, group by survey and Quarter, select only the main groups (as Haase) and see if it resemlbes the
# previous results.

fle <- d_wide4 %>%
  filter(predator_spec == "FLE") %>% 
  mutate(pred_cm = pred_size_mm/10,
         pred_cm_class = cut(pred_cm, breaks = c(0, 9, 20, 30, 200), right = TRUE))

head(data.frame(fle), 20)
unique(fle$pred_cm_class)

cod <- d_wide4 %>%
  filter(predator_spec == "COD") %>% 
  mutate(pred_cm = pred_size_mm/10,
         pred_cm_class = cut(pred_cm, breaks = c(0, 6, 20, 30, 40, 50, 200), right = TRUE))

head(data.frame(cod), 20)
unique(cod$pred_cm_class)
```

## Reproduce Haase figures with biomass proportions

```{r reproduce Haase figures}
# Try to reproduce Haase et al!
# Aggregate across predator individuals and convert to long data for plotting
cod2 <- cod %>%
  drop_na(pred_cm_class) %>% # This is because not all predators have length
  filter(cruise %in% c("BITS", "BITS-1", "BITS-2")) %>%
  filter(year %in% c(2015, 2016, 2017)) %>%
  filter(source == "Kevin's MSC") %>% 
  filter(!pred_cm_class == "(0,6]") %>% 
  group_by(quarter, pred_cm_class) %>% 
  summarise(sprattus_sprattus_tot_all = sum(sprattus_sprattus_tot),
            saduria_entomon_tot_all = sum(saduria_entomon_tot),
            mysidae_tot_all = sum(mysidae_tot),
            clupea_harengus_tot_all = sum(clupea_harengus_tot),
            sprattus_sprattus_tot_all = sum(sprattus_sprattus_tot),
            gobiidae_tot_all = sum(gobiidae_tot),
            gadiformes_tot_all = sum(gadiformes_tot),
            other_pisces_tot_all = sum(other_pisces_tot),
            polychaeta_tot_all = sum(polychaeta_tot)) %>% 
  ungroup() %>% 
  pivot_longer(3:10) %>% 
  group_by(quarter, pred_cm_class) %>% 
  mutate(percent = value/sum(value)) %>%
  ungroup()
  
# So much herring for small cod?
# A 20 cm cod weighs approx 100 g. Can it have 20g of herring in the stomach?
#small_cod <-
d %>%
  filter(Pred.size.mm < 200 & Prey.sp.code %in% c("clupea harengus", "Clupea harengus")) %>% 
  dplyr::select(Prey.weight, Prey.sp.code, Unique.pred.id, Pred.size.mm)

d_wide4 %>% filter(unique_pred_id == "2016_1_73_735_COD") %>% as.data.frame()
d %>% filter(Unique.pred.id == "2016_1_73_735_COD") %>% as.data.frame()

# Check sample sizes per size class (numbers below bars in Kevins figures)
cod %>%
  drop_na(pred_cm_class) %>% # This is because not all predators have length
  filter(cruise %in% c("BITS", "BITS-1", "BITS-2")) %>%
  filter(year %in% c(2015, 2016, 2017)) %>%
  filter(source == "Kevin's MSC") %>% 
  filter(!pred_cm_class == "(0,6]") %>% 
  group_by(quarter, pred_cm_class) %>% 
  summarise(n = n())
# I seem to have more data...  

# Check Kevin's raw data... 
kev <- read.csv("/Users/maxlindmark/Desktop/R_STUDIO_PROJECTS/bentfish/data/stomach_data/Master_Kevin_updated.csv", sep = ";")
head(kev)

kev$prey.weight <- as.numeric(gsub(",", ".", gsub("\\.", "", kev$prey.weight)))

kev %>% 
  filter(lengthclass == "Lc6-20" & pred.code == "COD" & year %in% c(2015, 2016, 2017) & quarter == 1) %>% 
  drop_na(prey.sp.code) %>%
  drop_na(prey.weight) %>%
  group_by(prey.sp.code) %>% 
  summarise(tot_weight_by_prey = sum(prey.weight)) %>% 
  arrange(desc(tot_weight_by_prey)) %>% 
  as.data.frame()

# OK so probably Kevin made some additional filter, because I also have a larger sample size
```

## Plot potential response variables... Unlike Haase, I want to work with individual stomachs

```{r plot potential response variables}
# Plot and calculate proportion empty stomachs
head(data.frame(cod))
cod %>% 
  mutate(empty_stomach = ifelse(tot_prey_biom == 0, "Y", "N")) %>% 
  ggplot(., aes(empty_stomach, fill = empty_stomach)) + 
  scale_fill_brewer(palette = "Set2") +
  geom_bar()

# Plot "stomach" fullness, i.e., the weight of prey in stomach (relative to predator weight)
# Can also be called Feeding Ratio, FR
t <- cod %>% drop_na(pred_weight_g)
t <- cod %>% drop_na(pred_cm)

# Next find the most abundance prey groups for cod and flounder (to see if the density has any effect
# on the biomass of common prey in their stomachs)
# To do that, I need long format again, group by prey item and summarise
colnames(cod)
cod_important_prey <- cod %>%
  pivot_longer(2:16) %>% 
  group_by(name) %>% 
  summarise(tot_prey = sum(value)) %>% 
  mutate(percent = round(tot_prey / sum(tot_prey), digits = 2)*100) %>%  # calculate also percent of total
  arrange(desc(tot_prey)) %>% 
  mutate(spec = "cod")

# Same for flounder
fle_important_prey <- fle %>%
  pivot_longer(2:16) %>% 
  group_by(name) %>% 
  summarise(tot_prey = sum(value)) %>% 
  mutate(percent = round(tot_prey / sum(tot_prey), digits = 2)*100) %>%  # calculate also percent of total
  arrange(desc(tot_prey)) %>% 
  mutate(spec = "fle")

plotdat <- bind_rows(cod_important_prey, fle_important_prey)

ggplot(plotdat, 
       aes(name, percent, percent, fill = spec)) +#aes(fct_reorder(name, percent, .desc = TRUE), percent, fill = spec)) +
  geom_bar(stat = "identity") + 
  theme_classic(base_size = 16) + 
  #coord_flip() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_brewer(palette = "Set2") + 
  NULL

# Ok, so the species that both prey feed on (even though very little(!)) are:
common_prey <- c("amphipoda_tot", "clupea_harengus_tot", "clupeidae_tot", "other_crustacea_tot",
                 "other_pisces_tot", "polychaeta_tot", "saduria_entomon_tot", "sprattus_sprattus_tot")


# Total feeding ratio, proportion of saduria and proportion of common prey!
# First for cod
cod_fr <- cod %>% 
  mutate(pred_weight_g = replace_na(pred_weight_g, -9)) %>% 
  mutate(pred_weight_g = ifelse(pred_weight_g == -9, 0.01*pred_cm^3, pred_weight_g)) %>% 
  mutate(FR_tot = (tot_prey_biom)/(pred_weight_g - tot_prey_biom),
         FR_saduria = (saduria_entomon_tot)/(pred_weight_g - tot_prey_biom)) %>%
  # mutate(FR_tot = tot_prey_biom/(pred_weight_g - tot_prey_biom),
  #        FR_saduria = saduria_entomon_tot/(pred_weight_g - tot_prey_biom)) %>%
  mutate(prop_saduria = saduria_entomon_tot/tot_prey_biom,
         prop_common = (amphipoda_tot + clupea_harengus_tot + clupeidae_tot + other_crustacea_tot +
                 other_pisces_tot + polychaeta_tot + saduria_entomon_tot + sprattus_sprattus_tot) / tot_prey_biom,
         common_tot = (amphipoda_tot + clupea_harengus_tot + clupeidae_tot + other_crustacea_tot +
                 other_pisces_tot + polychaeta_tot + saduria_entomon_tot + sprattus_sprattus_tot)) %>%
  filter(quarter %in% c(1, 4)) %>% 
  filter(lat < 58 & lat > 55) %>% 
  #filter(FR_tot > 0 & FR_tot < 1) #%>% # strange id: 2007_4_72_2007_11_6_72_DAN2_40G4_6_F_250_134_1_COD
  filter(FR_tot > 0)
  # I guess in theory the total stomach content could weigh more than the fish without food
  # dplyr::select(unique_pred_id, FR_tot) %>%
  # arrange(desc(FR_tot)) %>%
  # as.data.frame()

# Now flounder
# First for cod
fle_fr <- fle %>% 
  mutate(pred_weight_g = replace_na(pred_weight_g, -9)) %>% 
  mutate(pred_weight_g = ifelse(pred_weight_g == -9, 0.01*pred_cm^3, pred_weight_g)) %>% 
  mutate(FR_tot = (tot_prey_biom)/(pred_weight_g - tot_prey_biom),
         FR_saduria = (saduria_entomon_tot)/(pred_weight_g - tot_prey_biom)) %>%
  # mutate(FR_tot = tot_prey_biom/(pred_weight_g - tot_prey_biom),
  #        FR_saduria = saduria_entomon_tot/(pred_weight_g - tot_prey_biom)) %>%
  mutate(prop_saduria = saduria_entomon_tot/tot_prey_biom,
         prop_common = (amphipoda_tot + clupea_harengus_tot + clupeidae_tot + other_crustacea_tot +
                 other_pisces_tot + polychaeta_tot + saduria_entomon_tot + sprattus_sprattus_tot) / tot_prey_biom,
         common_tot = (amphipoda_tot + clupea_harengus_tot + clupeidae_tot + other_crustacea_tot +
                 other_pisces_tot + polychaeta_tot + saduria_entomon_tot + sprattus_sprattus_tot)) %>%
  filter(quarter %in% c(1, 4)) %>% 
  filter(lat < 58 & lat > 55) %>% 
  #filter(FR_tot > 0 & FR_tot < 1) #%>% # strange id: 2007_4_72_2007_11_6_72_DAN2_40G4_6_F_250_134_1_COD
  filter(FR_tot > 0)
  # I guess in theory the total stomach content could weigh more than the fish without food
  # dplyr::select(unique_pred_id, FR_tot) %>%
  # arrange(desc(FR_tot)) %>%
  # as.data.frame()

# What is the mean FR per year
cod %>% 
  mutate(pred_weight_g = replace_na(pred_weight_g, -9)) %>% 
  mutate(pred_weight_g = ifelse(pred_weight_g == -9, 0.01*pred_cm^3, pred_weight_g)) %>% 
  mutate(FR_tot = (100 * tot_prey_biom)/(pred_weight_g - tot_prey_biom),
         FR_saduria = (100 * saduria_entomon_tot)/(pred_weight_g - tot_prey_biom)) %>%
  filter(FR_tot > -1) %>% 
  group_by(year) %>% 
  summarise(mean_FR_tot = mean(FR_tot)) %>% 
  ggplot(., aes(year, mean_FR_tot)) + 
  geom_point(size = 4) + 
  stat_smooth() + 
  theme_classic(base_size = 18)

# Plot the distribution of FR
cod_fr %>% 
  ggplot(., aes(FR_tot)) + 
  geom_histogram() +  
  theme_classic(base_size = 14) +
  coord_cartesian(expand = 0) + 
  NULL

plot_map_raster +
  geom_point(data = cod_fr, aes(x = x * 1000, y = y * 1000, color = log(FR_tot))) +
  scale_color_viridis() + 
  facet_wrap(cruise ~ quarter) +
  theme_plot()

# Instead plot the proportion of saduria
plot_map_raster +
  geom_point(data = cod_fr, aes(x = x * 1000, y = y * 1000, color = prop_saduria)) +
  scale_color_viridis() + 
  #facet_wrap(cruise ~ quarter) +
  theme_plot()

# Plot the distribution of proportions - color if the prop is zero!
cod_fr %>% 
  mutate(saduria_category = ifelse(prop_saduria == 0, "No", "Some")) %>%
  mutate(saduria_category = ifelse(prop_saduria == 1, "Only", saduria_category)) %>% 
  ggplot(., aes(prop_saduria, fill = saduria_category)) + 
  geom_histogram() +  
  scale_fill_brewer(palette = "Set2") + 
  theme_classic(base_size = 14) +
  coord_cartesian(expand = 0) + 
  annotate("text", label = paste("Mean proportion Saduria = ",
                                 round(mean(cod_fr$prop_saduria), digits = 3)), size = 6,
           x = 0.5, y = 2000) + # add the mean proportion as text!
  NULL

cod_fr %>% 
  mutate(saduria_category = ifelse(prop_saduria == 0, "No", "Some")) %>%
  mutate(saduria_category = ifelse(prop_saduria == 1, "Only", saduria_category)) %>% 
  ggplot(., aes(prop_saduria, fill = saduria_category)) + 
  geom_histogram() +  
  facet_wrap(~ year, scales = "free") + 
  scale_fill_brewer(palette = "Set2") + 
  theme_classic(base_size = 14) +
  coord_cartesian(expand = 0) + 
  NULL
```

## Conduct test analyses
How does the proportion and total weight of prey per predator weight (prey here being total prey biomass, saduria biomass and biomass of common prey) relate to flounder, cod and total density of the two species? Do the same for flounder!

```{r test analysis}
# First read the density models and predict the values
# Note this overwrites many variables! Not optimal
qwraps2::lazyload_cache_dir(path = "R/analysis/density_spatial_trend_models_cache/html")

# Make predictions onto the stomach data defined earlier (1 row per stomach and prey?)

# Add depth and rename coordinates to match the data used for fitting the density model
# Read the tifs
west <- raster("/Users/maxlindmark/Desktop/R_STUDIO_PROJECTS/cod_condition/data/depth_geo_tif/D5_2018_rgb-1.tif")
#plot(west)

east <- raster("/Users/maxlindmark/Desktop/R_STUDIO_PROJECTS/cod_condition/data/depth_geo_tif/D6_2018_rgb-1.tif")
# plot(east)

dep_rast <- raster::merge(west, east)

cod_fr$depth <- extract(dep_rast, cod_fr[, 24:23])
fle_fr$depth <- extract(dep_rast, fle_fr[, 24:23])

# Convert to depth (instead of elevation)
ggplot(cod_fr, aes(depth)) + geom_histogram()
cod_fr$depth <- (cod_fr$depth - max(drop_na(cod_fr)$depth)) *-1
ggplot(cod_fr, aes(depth)) + geom_histogram()

fle_fr$depth <- (fle_fr$depth - max(drop_na(fle_fr)$depth)) *-1

ggplot(cod_fr, aes(x, y, color = depth)) + 
  geom_point() + 
  scale_color_viridis()

cod_fr <- cod_fr %>% rename("X" = "x", "Y" = "y")
cod_fr <- cod_fr %>% mutate(year = as.integer(year))
cod_fr <- cod_fr %>% mutate(year = as.integer(year))

fle_fr <- fle_fr %>% rename("X" = "x", "Y" = "y")
fle_fr <- fle_fr %>% mutate(year = as.integer(year))
fle_fr <- fle_fr %>% mutate(year = as.integer(year))

# Standardize depth to the DENSITY data, not this data set
density_dat <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/cod_condition/master/data/for_analysis/mdat_cpue.csv")

cod_fr <- cod_fr %>% mutate(depth_sc = (depth - mean(density_dat$depth)) / sd(density_dat$depth))
fle_fr <- fle_fr %>% mutate(depth_sc = (depth - mean(density_dat$depth)) / sd(density_dat$depth))

cod_fr2 <- cod_fr %>% filter(year < 2020) # Remove this after I've refitted the models with 2020!
fle_fr2 <- fle_fr %>% filter(year < 2020) # Remove this after I've refitted the models with 2020!

# Now predict using the density models
cod_stomach_predcod_density <- predict(mcod2, newdata = dplyr::select(cod_fr2, depth_sc, year, X, Y))
cod_stomach_predfle_density <- predict(mfle2, newdata = dplyr::select(cod_fr2, depth_sc, year, X, Y))

fle_stomach_predcod_density <- predict(mcod2, newdata = dplyr::select(fle_fr2, depth_sc, year, X, Y))
fle_stomach_predfle_density <- predict(mfle2, newdata = dplyr::select(fle_fr2, depth_sc, year, X, Y))

# head(dplyr::select(cod_fr2, X, Y))
# head(predcod_density)
# head(predfle_density)

cod_fr2$predcod_density <- exp(cod_stomach_predcod_density$est)
cod_fr2$predfle_density <- exp(cod_stomach_predfle_density$est)

fle_fr2$predcod_density <- exp(fle_stomach_predcod_density$est)
fle_fr2$predfle_density <- exp(fle_stomach_predfle_density$est)

# Add scales predicted densities to the stomach data
cod_fr2 <- cod_fr2 %>%
  mutate(predcod_density_sc = (predcod_density - mean(predcod_density))/sd(predcod_density),
         predfle_density_sc = (predfle_density - mean(predfle_density))/sd(predfle_density))

fle_fr2 <- fle_fr2 %>%
  mutate(predcod_density_sc = (predcod_density - mean(predcod_density))/sd(predcod_density),
         predfle_density_sc = (predfle_density - mean(predfle_density))/sd(predfle_density))

# Now plot stomach summaries against predicted densities
head(cod_fr2)
```

## Plot cod stomach against density

```{r plot cod stomach against density}
# Common prey
p1 <- ggplot(cod_fr2, aes(predcod_density_sc, prop_common)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop common prey vs cod density")

p2 <- ggplot(cod_fr2, aes(predcod_density_sc, common_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g common prey vs cod density")

p3 <- ggplot(cod_fr2, aes(predfle_density_sc, prop_common)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop common prey vs fle density")

p4 <- ggplot(cod_fr2, aes(predfle_density_sc, common_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g common prey vs fle density")

p5 <- ggplot(cod_fr2, aes(predfle_density_sc + predcod_density_sc, prop_common)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop common prey vs fle + cod density")

p6 <- ggplot(cod_fr2, aes(predfle_density_sc + predcod_density_sc, common_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g common prey vs fle + coddensity")

(p1|p2) / (p3|p4) / (p5|p6) + plot_annotation(title = "Cod stomachs", 
                                                  theme = theme(plot.title = element_text(size = 16)))

# Saduria
p7 <- ggplot(cod_fr2, aes(predcod_density_sc, prop_saduria)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs cod density")

p8 <- ggplot(cod_fr2, aes(predcod_density_sc, saduria_entomon_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g saduria vs cod density")

p9 <- ggplot(cod_fr2, aes(predfle_density_sc, prop_saduria)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs fle density")

p10 <- ggplot(cod_fr2, aes(predfle_density_sc, saduria_entomon_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g saduria vs fle density")

p11 <- ggplot(cod_fr2, aes(predfle_density_sc + predcod_density_sc, prop_saduria)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs fle + cod density")

p12 <- ggplot(cod_fr2, aes(predfle_density_sc + predcod_density_sc, saduria_entomon_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g saduria vs fle  + coddensity")

(p7|p8) / (p9|p10) / (p11|p12) + plot_annotation(title = "Cod stomachs", 
                                                  theme = theme(plot.title = element_text(size = 16)))

# Total stomach content (FR)
p13 <- ggplot(cod_fr2, aes(predcod_density_sc, FR_tot)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("FR vs cod density")

p14 <- ggplot(cod_fr2, aes(predfle_density_sc, FR_tot)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("FR vs fle density")

p15 <- ggplot(cod_fr2, aes(predfle_density_sc + predcod_density, FR_tot)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("FR vs fle  + coddensity")

(p13/p14/p15) + plot_annotation(title = "Cod stomachs", theme = theme(plot.title = element_text(size = 16)))

# Closer inspection of some of the plots...
ggplot(cod_fr2, aes(predfle_density_sc, prop_saduria)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2, method = "lm") + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs fle density")

summary(lm(cod_fr2$prop_saduria ~ cod_fr2$predfle_density))

ggplot(cod_fr2, aes(predfle_density, tot_prey_biom/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g tot. stomach vs fle density")

ggplot(cod_fr2, aes(predfle_density + predcod_density, tot_prey_biom/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g tot. stomach vs fle  + coddensity")

```

## Plot flounder stomach against density

```{r plot fle stomach against density}
# Common prey
p1 <- ggplot(fle_fr2, aes(predcod_density_sc, prop_common)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop common prey vs cod density")

p2 <- ggplot(fle_fr2, aes(predcod_density_sc, common_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g common prey vs cod density")

p3 <- ggplot(fle_fr2, aes(predfle_density_sc, prop_common)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop common prey vs fle density")

p4 <- ggplot(fle_fr2, aes(predfle_density_sc, common_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g common prey vs fle density")

p5 <- ggplot(fle_fr2, aes(predfle_density_sc + predcod_density_sc, prop_common)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop common prey vs fle + cod density")

p6 <- ggplot(fle_fr2, aes(predfle_density_sc + predcod_density_sc, common_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g common prey vs fle + coddensity")

(p1|p2) / (p3|p4) / (p5|p6) + plot_annotation(title = "Flounder stomachs", 
                                                  theme = theme(plot.title = element_text(size = 16)))

# Saduria
p7 <- ggplot(fle_fr2, aes(predcod_density_sc, prop_saduria)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs cod density")

p8 <- ggplot(fle_fr2, aes(predcod_density_sc, saduria_entomon_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g saduria vs cod density")

p9 <- ggplot(fle_fr2, aes(predfle_density_sc, prop_saduria)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs fle density")

p10 <- ggplot(fle_fr2, aes(predfle_density_sc, saduria_entomon_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g saduria vs fle density")

p11 <- ggplot(fle_fr2, aes(predfle_density_sc + predcod_density_sc, prop_saduria)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs fle + cod density")

p12 <- ggplot(fle_fr2, aes(predfle_density_sc + predcod_density_sc, saduria_entomon_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("g/g saduria vs fle  + coddensity")

(p7|p8) / (p9|p10) / (p11|p12) + plot_annotation(title = "Flounder stomachs", 
                                                  theme = theme(plot.title = element_text(size = 16)))

# FR
p13 <- ggplot(fle_fr2, aes(predcod_density_sc, FR_tot)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("FR vs cod density")

p14 <- ggplot(fle_fr2, aes(predfle_density_sc, FR_tot)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("FR vs fle density")

p15 <- ggplot(fle_fr2, aes(predfle_density_sc + predcod_density, FR_tot)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2) + 
  theme_classic(base_size = 13) +
  ggtitle("FR vs fle + coddensity")

(p13/p14/p15) + plot_annotation(title = "Flounder stomachs", theme = theme(plot.title = element_text(size = 16)))
```

## More in depth plots...

```{r more in depth plots}
# Does it seem like proportions of the diet changes with density, but not the total amount of food?
# Check saduria and flounder for instance.
pp7 <- ggplot(fle_fr2, aes(predcod_density_sc, prop_saduria)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2, method = "lm") + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs cod density")

pp8 <- ggplot(filter(fle_fr2, (saduria_entomon_tot/pred_weight_g) < 0.1),
             aes(predcod_density_sc, saduria_entomon_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2, method = "lm") + 
  theme_classic(base_size = 13) +
  ggtitle("g/g saduria vs cod density")

pp13 <- ggplot(filter(fle_fr2, (saduria_entomon_tot/pred_weight_g) < 0.1),
              aes(predcod_density_sc, FR_tot)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2, method = "lm") + 
  theme_classic(base_size = 13) +
  ggtitle("g/g tot. stomach vs cod density")

ppfle <- pp7/pp8/pp13 +
  plot_layout(ncol = 3) + 
  plot_annotation(title = "Flounder stomachs", theme = theme(plot.title = element_text(size = 16)))

# And that cod density is unaffected (or less at least)
p7 <- ggplot(filter(cod_fr2, (saduria_entomon_tot/pred_weight_g) < 0.02 & predfle_density_sc < 2),
             aes(predfle_density_sc, prop_saduria)) + # Crop it up a little!
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2, method = "lm") + 
  theme_classic(base_size = 13) +
  ggtitle("prop saduria vs fle density")

p8 <- ggplot(filter(cod_fr2, (saduria_entomon_tot/pred_weight_g) < 0.02 & predfle_density_sc < 2),
             aes(predfle_density_sc, saduria_entomon_tot/pred_weight_g)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2, method = "lm") + 
  theme_classic(base_size = 13) +
  ggtitle("g/g saduria vs fle density")

p13 <- ggplot(filter(cod_fr2, (saduria_entomon_tot/pred_weight_g) < 0.02 & predfle_density_sc < 2 & FR_tot < 0.5),
              aes(predfle_density_sc, FR_tot)) + 
  geom_point(size = 2, shape = 21, fill = "black", color = "white", alpha = 0.8) + 
  stat_smooth(size = 2, method = "lm") + 
  theme_classic(base_size = 13) +
  ggtitle("g/g tot. stomach vs fle density")

ppcod <- p7/p8/p13 +
  plot_layout(ncol = 3) +
  plot_annotation(title = "Cod stomachs", theme = theme(plot.title = element_text(size = 16)))

ppfle / ppcod

# What does it mean? Yes, the proportion *may* be negatively affected by densities, 
# but the food content is not, which I guess would matter for condition
```

## Try and fit sdmTMB models with densities as covariates... 

```{r sdmTMB models fitted to diet, cache=TRUE}
# Cod 
pcod_spde <- make_mesh(cod_fr2, c("X", "Y"), n_knots = 150, type = "kmeans", seed = 42)
plot(pcod_spde)

pfle_spde <- make_mesh(fle_fr2, c("X", "Y"), n_knots = 70, type = "kmeans", seed = 42)
plot(pfle_spde)

# (add small values if 0, subtract small values if 1) for Beta regressions
cod_fr2 <- cod_fr2 %>%
  mutate(saduria_entomon_per_mass = saduria_entomon_tot/pred_weight_g,
         prop_saduria2 = ifelse(prop_saduria == 0, prop_saduria + 0.0001, prop_saduria),
         prop_saduria2 = ifelse(prop_saduria == 1, prop_saduria - 0.0001, prop_saduria2))

fle_fr2 <- fle_fr2 %>%
  mutate(saduria_entomon_per_mass = saduria_entomon_tot/pred_weight_g,
         prop_saduria2 = ifelse(prop_saduria == 0, prop_saduria + 0.0001, prop_saduria),
         prop_saduria2 = ifelse(prop_saduria == 1, prop_saduria - 0.0001, prop_saduria2)) 

# OK, proportion models look absolutely AWFUL. I will model stomach content with a tweedie instead

# Proportion Saduria
# mcodsad <- sdmTMB(
#   data = cod_fr2, 
#   formula = prop_saduria2 ~ 0 + as.factor(year) + predfle_density_sc + predcod_density_sc,
#   time = "year", fields = "IID", spatial_only = FALSE, spde = pcod_spde, family = student(df = 5))

mcodsad <- sdmTMB(
  data = cod_fr2, 
  formula = saduria_entomon_per_mass ~ 0 + as.factor(year) + s(predfle_density_sc) + s(predcod_density_sc),
  time = "year", fields = "IID", spatial_only = FALSE, spde = pcod_spde, family = tweedie())

cod_fr2$resids_mcodsad <- residuals(mcodsad) # randomized quantile residuals
hist(cod_fr2$resids_mcodsad)
qqnorm(cod_fr2$resids_mcodsad); abline(a = 0, b = 1)

tidy(mcodsad)
summary(mcodsad)

mflesad <- sdmTMB(
  data = fle_fr2, 
  formula = saduria_entomon_per_mass ~ 0 + as.factor(year) + s(predfle_density_sc) + s(predcod_density_sc),
  time = "year", fields = "IID", spatial_only = FALSE, spde = pfle_spde, family = tweedie())

tidy(mflesad)
summary(mflesad)

fle_fr2$resids_mflesad <- residuals(mflesad) # randomized quantile residuals
hist(fle_fr2$resids_mflesad)
qqnorm(fle_fr2$resids_mflesad); abline(a = 0, b = 1)

# Plot marginal effects
## Flounder
# Flounder density
nd_fle_fle <- data.frame(predfle_density_sc = seq(min(fle_fr2$predfle_density_sc),
                                                  max(fle_fr2$predfle_density_sc), length.out = 100))

nd_fle_fle$year <- 2018L
nd_fle_fle$predcod_density_sc <- 0

pred_fle_fle <- predict(mflesad, newdata = nd_fle_fle, se_fit = TRUE, re_form = NA)

p1 <- ggplot(pred_fle_fle, aes(predfle_density_sc, exp(est),
  ymin = exp(est - 1.96 * est_se), ymax = exp(est + 1.96 * est_se))) +
  geom_line() + geom_ribbon(alpha = 0.4) +
  theme_classic(base_size = 14) + 
  ggtitle("Fle stomach, flounder margin")

# Cod density
nd_fle_cod <- data.frame(predcod_density_sc = seq(min(fle_fr2$predcod_density_sc),
                                                  max(fle_fr2$predcod_density_sc), length.out = 100))

nd_fle_cod$year <- 2018L
nd_fle_cod$predfle_density_sc <- 0

pred_fle_cod <- predict(mflesad, newdata = nd_fle_cod, se_fit = TRUE, re_form = NA)

p2 <- ggplot(pred_fle_cod, aes(predcod_density_sc, exp(est),
  ymin = exp(est - 1.96 * est_se), ymax = exp(est + 1.96 * est_se))) +
  geom_line() + geom_ribbon(alpha = 0.4) + 
  theme_classic(base_size = 14) +
  ggtitle("Fle stomach, cod margin")

flemargin <- p1 + p2 + plot_annotation(title = "Flounder marginal effects",
                                       theme = theme(plot.title = element_text(size = 16)))

## Cod
# Flounder density
nd_cod_fle <- data.frame(predfle_density_sc = seq(min(cod_fr2$predfle_density_sc),
                                                  max(cod_fr2$predfle_density_sc), length.out = 100))

nd_cod_fle$year <- 2018L
nd_cod_fle$predcod_density_sc <- 0

pred_cod_fle <- predict(mcodsad, newdata = nd_cod_fle, se_fit = TRUE, re_form = NA)

p3 <- ggplot(pred_cod_fle, aes(predfle_density_sc, exp(est),
  ymin = exp(est - 1.96 * est_se), ymax = exp(est + 1.96 * est_se))) +
  geom_line() + geom_ribbon(alpha = 0.4) +
  theme_classic(base_size = 14) +
  ggtitle("Cod stomach, flounder margin")

# Cod density
nd_cod_cod <- data.frame(predcod_density_sc = seq(min(cod_fr2$predcod_density_sc),
                                                  max(cod_fr2$predcod_density_sc), length.out = 100))

nd_cod_cod$year <- 2018L
nd_cod_cod$predfle_density_sc <- 0

pred_cod_cod <- predict(mcodsad, newdata = nd_cod_cod, se_fit = TRUE, re_form = NA)

p4 <- ggplot(pred_cod_cod, aes(predcod_density_sc, exp(est),
  ymin = exp(est - 1.96 * est_se), ymax = exp(est + 1.96 * est_se))) +
  geom_line() + geom_ribbon(alpha = 0.4) + 
  theme_classic(base_size = 14) +
  ggtitle("Cod stomach, cod margin")


(p1 | p2) / (p3 | p4 )
```









