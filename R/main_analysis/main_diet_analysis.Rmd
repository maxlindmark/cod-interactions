---
title: "Fit spatiotemporal diet models with covariates"
author: "Max Lindmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro
In this script, I take the collated stomach data set and calculate aggregates (feeding ratio, total weight of prey groups) and predictor variables for diet data, aggregate to get 1 stomach = 1 row per prey type (not prey individual). I also select only the columns I need for model fitting, join environmental covariates and cpue covariates for cod and flounder, and lastly saduria biomass densities.

## Load packages & source functions

```{r load libraries, message=FALSE, warning=TRUE}
# Load libraries, install if needed
library(tidyverse)
library(readxl)
library(tidylog)
library(RCurl)
library(RColorBrewer)
library(patchwork)
library(viridis)
library(sdmTMB)
library(mapplots)
library(sp)
library(raster)
library(ggeffects)
library(modelr)

# Source code for lan_lot to UTM
source("/Users/maxlindmark/Dropbox/Max work/R/cod_interactions/R/functions/lon_lat_utm.R")

# Source code for map plots
source("/Users/maxlindmark/Dropbox/Max work/R/cod_interactions/R/functions/map_plot.R")

# Trim the map plot to better fit stomach data
xmin2 <- 303000
xmax2 <- 916000
xrange <- xmax2 - xmin2

ymin2 <- 5980000
ymax2 <- 6580000
yrange <- ymax2 - ymin2

theme_set(theme_plot())

plot_map_fc2 <- plot_map_fc +
  theme(legend.position = "bottom") +
  xlim(xmin2*1.5, xmax2*0.9) +
  ylim(ymin2*1.025, ymax2*0.98268)

# Continuous colors
options(ggplot2.continuous.colour = "viridis")
```

## Read stomach data

```{r read data, warning=FALSE}
small_cod_stomach <- read_csv("data/clean/small_cod_stomach.csv") %>% 
  drop_na(oxy, temp, depth, scod_kg_km2, lcod_kg_km2, fle_kg_km2) %>% 
  rename(density_cod_small = scod_kg_km2,
         density_cod_large = lcod_kg_km2,
         density_flounder = fle_kg_km2) %>% 
  mutate(fyear = as.factor(year),
         fquarter = as.factor(quarter),
         ices_rect = as.factor(ices_rect),
         oxy_sc = (oxy - mean(oxy)) / sd(oxy),
         temp_sc = (temp - mean(temp)) / sd(temp),
         depth_sc = (depth - mean(depth)) / sd(depth),
         density_saduria_sc = (density_saduria - mean(density_saduria)) / sd(density_saduria),
         density_cod_small_sc = (density_cod_small - mean(density_cod_small)) / sd(density_cod_small),
         density_cod_large_sc = (density_cod_large - mean(density_cod_large)) / sd(density_cod_large),
         density_flounder_sc = (density_flounder - mean(density_flounder)) / sd(density_flounder),
         haul_id = as.factor(haul_id),
         species2 = "Small cod")

large_cod_stomach <- read_csv("data/clean/large_cod_stomach.csv") %>% 
  drop_na(oxy, temp, depth, scod_kg_km2, lcod_kg_km2, fle_kg_km2) %>% 
  rename(density_cod_small = scod_kg_km2,
         density_cod_large = lcod_kg_km2,
         density_flounder = fle_kg_km2) %>% 
  mutate(fyear = as.factor(year),
         fquarter = as.factor(quarter),
         ices_rect = as.factor(ices_rect),
         oxy_sc = (oxy - mean(oxy)) / sd(oxy),
         temp_sc = (temp - mean(temp)) / sd(temp),
         depth_sc = (depth - mean(depth)) / sd(depth),
         density_saduria_sc = (density_saduria - mean(density_saduria)) / sd(density_saduria),
         density_cod_small_sc = (density_cod_small - mean(density_cod_small)) / sd(density_cod_small),
         density_cod_large_sc = (density_cod_large - mean(density_cod_large)) / sd(density_cod_large),
         density_flounder_sc = (density_flounder - mean(density_flounder)) / sd(density_flounder),
         haul_id = as.factor(haul_id),
         species2 = "Large cod")

flounder_stomach <- read_csv("data/clean/flounder_stomach.csv") %>% 
  drop_na(oxy, temp, depth, scod_kg_km2, lcod_kg_km2, fle_kg_km2) %>% 
  rename(density_cod_small = scod_kg_km2,
         density_cod_large = lcod_kg_km2,
         density_flounder = fle_kg_km2) %>% 
  mutate(fyear = as.factor(year),
         fquarter = as.factor(quarter),
         ices_rect = as.factor(ices_rect),
         oxy_sc = (oxy - mean(oxy)) / sd(oxy),
         temp_sc = (temp - mean(temp)) / sd(temp),
         depth_sc = (depth - mean(depth)) / sd(depth),
         density_saduria_sc = (density_saduria - mean(density_saduria)) / sd(density_saduria),
         density_cod_small_sc = (density_cod_small - mean(density_cod_small)) / sd(density_cod_small),
         density_cod_large_sc = (density_cod_large - mean(density_cod_large)) / sd(density_cod_large),
         density_flounder_sc = (density_flounder - mean(density_flounder)) / sd(density_flounder),
         haul_id = as.factor(haul_id),
         species2 = "Flounder")

# Load cache
# qwraps2::lazyload_cache_dir(path = "R/main_analysis/main_diet_analysis_cache/html")
```

## Read the prediction grid (scales variables wrt data!)

```{r}
# I need predicted cod and flounder densities for this

# pred_grid_1 <- read_csv("/Users/maxlindmark/Dropbox/Max work/R/cod_interactions/data/clean/pred_grid_(1_2).csv")
# pred_grid_2 <- read_csv("/Users/maxlindmark/Dropbox/Max work/R/cod_interactions/data/clean/pred_grid_(2_2).csv")
# 
# pred_grid <- bind_rows(pred_grid_1, pred_grid_2)
```

## Plot data in space

```{r plot in space}
full_dat <- bind_rows(small_cod_stomach, large_cod_stomach, flounder_stomach) %>% 
  pivot_longer(c(tot_feeding_ratio, saduria_feeding_ratio, benthic_feeding_ratio),
               names_to = "prey_group",
               values_to = "feeding_ratio")

## Total feeding ratio
# Q1
plot_map_fc2 +
  geom_point(data = filter(full_dat, quarter == 1 & prey_group == "tot_feeding_ratio"), aes(X*1000, Y*1000, color = feeding_ratio)) +
  facet_grid(species2 ~ year) +
  scale_color_viridis(trans = "sqrt", name = "") +
  labs(title = "Total feeding ratio", subtitle = "Quarter 1") +
  theme(legend.text = element_text(angle = 90))

ggsave("figures/supp/data_in_space_q1.pdf", width = 17, height = 17, units = "cm")

# Q4
plot_map_fc2 +
  geom_point(data = filter(full_dat, quarter == 4 & prey_group == "tot_feeding_ratio"), aes(X*1000, Y*1000, color = feeding_ratio)) +
  facet_grid(species2 ~ year) +
  scale_color_viridis(trans = "sqrt", name = "") +
  labs(title = "Total feeding ratio", subtitle = "Quarter 4") +
  theme(legend.text = element_text(angle = 90))

ggsave("figures/supp/data_in_space_q4.pdf", width = 17, height = 17, units = "cm")

## Benthic feeding ratio
# Q1
plot_map_fc2 +
  geom_point(data = filter(full_dat, quarter == 1 & prey_group == "benthic_feeding_ratio"), aes(X*1000, Y*1000, color = feeding_ratio)) +
  facet_grid(species2 ~ year) +
  scale_color_viridis(trans = "sqrt") +
  labs(title = "Benthic feeding ratio", subtitle = "Quarter 1") +
  theme(legend.text = element_text(angle = 90))

# Q4
plot_map_fc2 +
  geom_point(data = filter(full_dat, quarter == 4 & prey_group == "benthic_feeding_ratio"), aes(X*1000, Y*1000, color = feeding_ratio)) +
  facet_grid(species2 ~ year) +
  scale_color_viridis(trans = "sqrt") +
  labs(title = "Benthic feeding ratio", subtitle = "Quarter 4") +
  theme(legend.text = element_text(angle = 90))

## Saduria feeding ratio
# Q1
plot_map_fc2 +
  geom_point(data = filter(full_dat, quarter == 1 & prey_group == "saduria_feeding_ratio"), aes(X*1000, Y*1000, color = feeding_ratio)) +
  facet_grid(species2 ~ year) +
  scale_color_viridis(trans = "sqrt") +
  labs(title = "Saduria feeding ratio", subtitle = "Quarter 1") +
  theme(legend.text = element_text(angle = 90))

# Q4
plot_map_fc2 +
  geom_point(data = filter(full_dat, quarter == 4 & prey_group == "saduria_feeding_ratio"), aes(X*1000, Y*1000, color = feeding_ratio)) +
  facet_grid(species2 ~ year) +
  scale_color_viridis(trans = "sqrt") +
  labs(title = "Saduria feeding ratio", subtitle = "Quarter 4") +
  theme(legend.text = element_text(angle = 90))
```

## Plot data (response vs explanatory variables)

```{r}
ggplot(full_dat, aes(depth, feeding_ratio)) + 
  geom_point() + 
  stat_smooth() + 
  facet_wrap(prey_group ~ species2, scales = "free")

ggplot(full_dat, aes(oxy, feeding_ratio)) + 
  geom_point() + 
  stat_smooth() + 
  facet_wrap(prey_group ~ species2, scales = "free")

ggplot(full_dat, aes(temp, feeding_ratio)) + 
  geom_point() + 
  stat_smooth() + 
  facet_wrap(prey_group ~ species2, scales = "free")

ggplot(full_dat, aes(density_flounder_sc, feeding_ratio)) + 
  geom_point() + 
  stat_smooth() + 
  facet_wrap(prey_group ~ species2, scales = "free")

ggplot(full_dat, aes(density_cod_large_sc, feeding_ratio)) + 
  geom_point() + 
  stat_smooth() + 
  facet_wrap(prey_group ~ species2, scales = "free")

ggplot(full_dat, aes(density_cod_small_sc, feeding_ratio)) + 
  geom_point() + 
  stat_smooth() + 
  facet_wrap(prey_group ~ species2, scales = "free")

# Saduria
ggplot(full_dat %>% filter(prey_group == "saduria_feeding_ratio"),
       aes(density_saduria_sc, feeding_ratio)) + 
  geom_point() + 
  stat_smooth() + 
  facet_wrap(~ species2, scales = "free", ncol = 2)
```

## Fit spatiotemporal model to feeding ratio
sdmTMB models with densities as covariates to stomach content data. First make mesh:

```{r spdes}
# Small cod
small_cod_spde <- make_mesh(small_cod_stomach,
                            c("X", "Y"),
                            cutoff = 15,
                            type = "kmeans",
                            seed = 42)
plot(small_cod_spde)


# Large cod
large_cod_spde <- make_mesh(large_cod_stomach,
                            c("X", "Y"),
                            n_knots = 75,
                            type = "kmeans",
                            seed = 42)
plot(large_cod_spde)


# Flounder
flounder_spde <- make_mesh(flounder_stomach,
                           c("X", "Y"),
                           n_knots = 75,
                           type = "kmeans",
                           seed = 42)
plot(flounder_spde)
```

```{r small cod total prey, cache=TRUE}
# s_cod_tot0 <- sdmTMB(
#   data = small_cod_stomach,
#   formula = tot_feeding_ratio ~ 0 + fyear + quarter,
#   family = tweedie(link = "log"),
#   time = "year",
#   spatiotemporal = "off",
#   spatial = "off",
#   mesh = small_cod_spde,
#   control = sdmTMBcontrol(newton_loops = 1)
#   )
# 
# tidy(s_cod_tot0)
# sanity(s_cod_tot0)
# 
# # Plot residuals in space
# small_cod_stomach$tot_resid0 <- residuals(s_cod_tot0)
# 
# plot_map_fc2 +
#   geom_point(data = filter(small_cod_stomach, tot_resid < 4), aes(X*1000, Y*1000, fill = tot_resid0), size = 3,
#              shape = 21, color = "grey50", stroke = 0.2) +
#   scale_fill_gradient2()
# 
# 
# s_cod_tot <- sdmTMB(
#   data = small_cod_stomach,
#   formula = tot_feeding_ratio ~ 0 + fyear + quarter + temp_sc + depth_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc*oxy_sc,
#   family = tweedie(link = "log"),
#   time = "year",
#   spatiotemporal = "off",
#   spatial = "off",
#   mesh = small_cod_spde,
#   priors = sdmTMBpriors(
#     b = normal(c(rep(NA, 7), rep(0, 7)),
#                c(rep(NA, 7), rep(1, 7)))),
#   control = sdmTMBcontrol(newton_loops = 1)
#   )
# 
# tidy(s_cod_tot)
# sanity(s_cod_tot)
# 
# # Plot residuals in space
# small_cod_stomach$tot_resid <- residuals(s_cod_tot)
# 
# # plot_map_fc2 +
# #   geom_point(data = small_cod_stomach, aes(X*1000, Y*1000, fill = tot_resid), size = 3,
# #              shape = 21, color = "grey50", stroke = 0.2) +
# #   facet_wrap(~ year) +
# #   scale_fill_gradient2()
# #
# # plot_map_fc2 +
# #   geom_point(data = filter(small_cod_stomach, tot_resid < 5), aes(X*1000, Y*1000, fill = tot_resid), size = 3,
# #              shape = 21, color = "grey50", stroke = 0.2) +
# #   facet_wrap(~ year) +
# #   scale_fill_gradient2()
# 
# plot_map_fc2 +
#   geom_point(data = filter(small_cod_stomach, tot_resid < 4), aes(X*1000, Y*1000, fill = tot_resid), size = 3,
#              shape = 21, color = "grey50", stroke = 0.2) +
#   scale_fill_gradient2()
# 
# # Fit model now with spatial random effect
# s_cod_tot2 <- sdmTMB(
#   data = small_cod_stomach,
#   formula = tot_feeding_ratio ~ 0 + fyear + quarter + temp_sc + depth_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc*oxy_sc,
#   family = tweedie(link = "log"),
#   time = "year",
#   spatiotemporal = "off",
#   spatial = "on",
#   mesh = small_cod_spde,
#   priors = sdmTMBpriors(
#     b = normal(c(rep(NA, 7), rep(0, 7)),
#                c(rep(NA, 7), rep(1, 7)))),
#   control = sdmTMBcontrol(newton_loops = 1)
#   )
# 
# print(s_cod_tot2)
# tidy(s_cod_tot2)
# sanity(s_cod_tot2)
# 
# small_cod_stomach$tot_resid2 <- residuals(s_cod_tot2)
# 
# plot_map_fc2 +
#   geom_point(data = filter(small_cod_stomach, tot_resid < 4), aes(X*1000, Y*1000, fill = tot_resid2), size = 3,
#              shape = 21, color = "grey50", stroke = 0.2) +
#   scale_fill_gradient2()
# 
# # Fit model now with spatiotemporal random effect
# s_cod_tot3 <- sdmTMB(
#   data = small_cod_stomach,
#   formula = tot_feeding_ratio ~ 0 + fyear + quarter + temp_sc + depth_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc*oxy_sc,
#   family = tweedie(link = "log"),
#   time = "year",
#   spatiotemporal = "IID",
#   spatial = "off",
#   mesh = small_cod_spde,
#   priors = sdmTMBpriors(
#     b = normal(c(rep(NA, 7), rep(0, 7)),
#                c(rep(NA, 7), rep(1, 7)))),
#   control = sdmTMBcontrol(newton_loops = 1)
#   )
# 
# print(s_cod_tot3)
# tidy(s_cod_tot3)
# sanity(s_cod_tot3)
# 
# small_cod_stomach$tot_resid3 <- residuals(s_cod_tot3)
# 
# plot_map_fc2 +
#   geom_point(data = filter(small_cod_stomach, tot_resid < 4), aes(X*1000, Y*1000, fill = tot_resid3), size = 3,
#              shape = 21, color = "grey50", stroke = 0.2) +
#   scale_fill_gradient2()
# 
# # Fit model now with spatiotemporal AND spatial random effect
# s_cod_tot4 <- sdmTMB(
#   data = small_cod_stomach,
#   formula = tot_feeding_ratio ~ 0 + fyear + quarter + temp_sc + depth_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc*oxy_sc,
#   family = tweedie(link = "log"),
#   time = "year",
#   spatiotemporal = "IID",
#   spatial = "on",
#   mesh = small_cod_spde,
#   priors = sdmTMBpriors(
#     b = normal(c(rep(NA, 7), rep(0, 7)),
#                c(rep(NA, 7), rep(1, 7)))),
#   control = sdmTMBcontrol(newton_loops = 1)
#   )
# 
# print(s_cod_tot4)
# tidy(s_cod_tot4)
# sanity(s_cod_tot4)
# 
# small_cod_stomach$tot_resid4 <- residuals(s_cod_tot4)
# 
# plot_map_fc2 +
#   geom_point(data = filter(small_cod_stomach, tot_resid < 4), aes(X*1000, Y*1000, fill = tot_resid4), size = 3,
#              shape = 21, color = "grey50", stroke = 0.2) +
#   scale_fill_gradient2()
# 
# 
# # Just random effects...
# small_cod_stomach$ices_rect <- as.factor(small_cod_stomach$ices_rect)
# 
# s_cod_tot5 <- sdmTMB(
#   data = small_cod_stomach,
#   formula = tot_feeding_ratio ~ 0 + fyear + quarter + temp_sc + depth_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc*oxy_sc + (1|ices_rect) + (1|haul_id),
#   family = tweedie(link = "log"),
#   time = "year",
#   spatiotemporal = "off",
#   spatial = "off",
#   mesh = small_cod_spde,
#   priors = sdmTMBpriors(
#     b = normal(c(rep(NA, 7), rep(0, 7)),
#                c(rep(NA, 7), rep(1, 7)))),
#   control = sdmTMBcontrol(newton_loops = 1)
#   )
# 
# print(s_cod_tot5)
# tidy(s_cod_tot5)
# sanity(s_cod_tot5)
# 
# small_cod_stomach$tot_resid5 <- residuals(s_cod_tot5)
# 
# plot_map_fc2 +
#   geom_point(data = filter(small_cod_stomach, tot_resid < 4), aes(X*1000, Y*1000, fill = tot_resid5), size = 3,
#              shape = 21, color = "grey50", stroke = 0.2) +
#   scale_fill_gradient2()
# 
# 
# # Plot together
# long <- small_cod_stomach %>%
#   pivot_longer(c(tot_resid0, tot_resid, tot_resid2, tot_resid3, tot_resid4, tot_resid5), names_to = "Model", values_to = "Residuals")
# 
# plot_map_fc2 +
#   geom_jitter(data = long %>% filter(Residuals < 4), aes(X*1000, Y*1000, fill = Residuals), size = 3,
#              shape = 21, color = "grey50", stroke = 0.1) +
#   scale_fill_gradient2() +
#   facet_wrap(~Model, ncol = 3)
# 
# plot_map_fc2 +
#   geom_jitter(data = long %>% filter(Residuals < 4), aes(X*1000, Y*1000, fill = Residuals), size = 3,
#              shape = 21, color = "grey50", stroke = 0.1) +
#   scale_fill_gradient2() +
#   facet_grid(year ~ Model)
# 
# 
# # Plot spatial and spatiotemporal random effect
# pred_grid_small <- pred_grid %>%
#   filter(quarter == 4) %>%
#   mutate(X = X/1000,
#          Y = Y/1000) %>%
#   filter(year %in% unique(small_cod_stomach$year)) %>%
#   filter(X < max(small_cod_stomach$X)) %>%
#   filter(X > min(small_cod_stomach$X)) %>%
#   filter(Y < max(small_cod_stomach$Y)) %>%
#   filter(Y > min(small_cod_stomach$Y))
# 
# pred_grid_small <- pred_grid_small %>%
#   mutate(fyear = factor(year),
#          fquarter = factor(quarter),
#          temp_sc = 0,
#          depth_sc = 0,
#          density_cod_small_sc = 0,
#          density_cod_large_sc = 0,
#          density_flounder_sc = 0,
#          oxy_sc = 0)
# 
# spat_pred <- predict(s_cod_tot2, newdata = pred_grid_small)
# 
# plot_map_fc2 +
#   geom_raster(data = spat_pred, aes(X*1000, Y*1000, fill = omega_s)) +
#   scale_fill_gradient2()
# 
# spat_pred2 <- predict(s_cod_tot3, newdata = pred_grid_small)
# 
# plot_map_fc2 +
#   geom_raster(data = spat_pred2, aes(X*1000, Y*1000, fill = epsilon_st)) +
#   scale_fill_gradient2() +
#   facet_wrap(~year)
# 
# AIC(s_cod_tot0, s_cod_tot, s_cod_tot2, s_cod_tot3, s_cod_tot4, s_cod_tot5)
```

### Small cod

```{r small cod, cache=TRUE}
# Total
s_cod_tot <- sdmTMB(
  data = small_cod_stomach,
  formula = tot_feeding_ratio ~ 
    0 +
    fyear +
    fquarter +
    temp_sc +
    depth_sc +
    oxy_sc + 
    density_cod_small_sc + 
    density_cod_large_sc + 
    density_flounder_sc +
    (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = small_cod_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 6)),
               c(rep(NA, 7), rep(1, 6)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(s_cod_tot)
tidy(s_cod_tot)
sanity(s_cod_tot)

# Benthic
s_cod_ben <- sdmTMB(
  data = small_cod_stomach,
  formula = benthic_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + depth_sc + oxy_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc + (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = small_cod_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 6)),
               c(rep(NA, 7), rep(1, 6)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(s_cod_ben)
tidy(s_cod_ben)
sanity(s_cod_ben)

# Saduria
s_cod_sad <- sdmTMB(
  data = small_cod_stomach,
  formula = saduria_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + oxy_sc + depth_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc*density_saduria_sc + (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = small_cod_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 8)),
               c(rep(NA, 7), rep(1, 8)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(s_cod_sad)
tidy(s_cod_sad)
sanity(s_cod_sad)
```

```{r}
# Test residuals for single model, tweedie vs lognormal
# s_cod_tot2 <- sdmTMB(
#   data = small_cod_stomach,
#   formula = tot_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + depth_sc + density_cod_small_sc + 
#     density_cod_large_sc + density_flounder_sc*oxy_sc + (1|haul_id),
#   family = tweedie(),
#   time = "year",
#   spatiotemporal = "off",
#   spatial = "off",
#   mesh = small_cod_spde,
#   priors = sdmTMBpriors(
#     b = normal(c(rep(NA, 7), rep(0, 7)),
#                c(rep(NA, 7), rep(1, 7)))),
#   control = sdmTMBcontrol(newton_loops = 1)
#   )
# 
# # Delta-Lognormal
# small_cod_stomach$res <- residuals(s_cod_tot)
# 
# p1 <- plot_map_fc2 +
#   geom_point(data = small_cod_stomach, aes(X*1000, Y*1000, fill = res), size = 2, shape = 21, color = "grey50", stroke = 0.2) +
#   scale_fill_gradient2() + 
#   ggtitle("Delta-Lognormal")
# 
# mcmc_res <- residuals(s_cod_tot, type = "mle-mcmc", mcmc_iter = 201, mcmc_warmup = 200)
# p1b <- ggplot(as.data.frame(mcmc_res), aes(sample = mcmc_res)) + stat_qq() + stat_qq_line() + theme(aspect.ratio = 1)
# qqnorm(mcmc_res);qqline(mcmc_res)
# 
# # Tweedie
# small_cod_stomach$res2 <- residuals(s_cod_tot2)
# 
# p2 <- plot_map_fc2 +
#   geom_point(data = small_cod_stomach, aes(X*1000, Y*1000, fill = res2), size = 2, shape = 21, color = "grey50", stroke = 0.2) +
#   scale_fill_gradient2() + 
#   ggtitle("Tweedie")
# 
# mcmc_res2 <- residuals(s_cod_tot2, type = "mle-mcmc", mcmc_iter = 201, mcmc_warmup = 200) %>% as.data.frame()
# p2b <- ggplot(mcmc_res2, aes(sample = V1)) + stat_qq() + stat_qq_line() + theme(aspect.ratio = 1)
# 
# # Plot!
# (p1 + p2 + p1b + p2b) + plot_layout(heights = c(2, 1))
```

#### Large cod

```{r large cod, cache=TRUE}
# Total
l_cod_tot <- sdmTMB(
  data = large_cod_stomach,
  formula = tot_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + depth_sc + oxy_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc + (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = large_cod_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 6)),
               c(rep(NA, 7), rep(1, 6)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(l_cod_tot)
tidy(l_cod_tot)
sanity(l_cod_tot)

# Benthic
l_cod_ben <- sdmTMB(
  data = large_cod_stomach,
  formula = benthic_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + depth_sc + oxy_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc + (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = large_cod_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 6)),
               c(rep(NA, 7), rep(1, 6)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(l_cod_ben)
tidy(l_cod_ben)
sanity(l_cod_ben)

# Saduria
l_cod_sad <- sdmTMB(
  data = large_cod_stomach,
  formula = saduria_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + oxy_sc + depth_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc*density_saduria_sc + (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = large_cod_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 8)),
               c(rep(NA, 7), rep(1, 8)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(l_cod_sad)
tidy(l_cod_sad)
sanity(l_cod_sad)
```

#### Flounder

```{r flounder, cache=TRUE}
# Total
fle_tot <- sdmTMB(
  data = flounder_stomach,
  formula = tot_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + depth_sc + oxy_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc + (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = flounder_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 6)),
               c(rep(NA, 7), rep(1, 6)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(fle_tot)
tidy(fle_tot)
sanity(fle_tot)

# Benthic
fle_ben <- sdmTMB(
  data = flounder_stomach,
  formula = benthic_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + depth_sc + oxy_sc + density_cod_small_sc + density_cod_large_sc + density_flounder_sc + (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = flounder_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 6)),
               c(rep(NA, 7), rep(1, 6)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(fle_ben)
tidy(fle_ben)
sanity(fle_ben)

# Saduria
fle_sad <- sdmTMB(
  data = flounder_stomach,
  formula = saduria_feeding_ratio ~ 0 + fyear + fquarter + temp_sc + oxy_sc + depth_sc + density_flounder_sc + density_cod_large_sc + density_cod_small_sc*density_saduria_sc + (1|haul_id),
  family = delta_lognormal(),
  time = "year",
  spatiotemporal = "off",
  spatial = "off",
  mesh = flounder_spde,
  priors = sdmTMBpriors(
    b = normal(c(rep(NA, 7), rep(0, 8)),
               c(rep(NA, 7), rep(1, 8)))),
  control = sdmTMBcontrol(newton_loops = 1)
  )

print(fle_sad)
tidy(fle_sad)
sanity(fle_sad)
```

```{r }
mcmc_res_fle_sad <- residuals(fle_sad,
                              type = "mle-mcmc",
                              mcmc_iter = 201,
                              mcmc_warmup = 200)

qqnorm(mcmc_res_fle_sad); qqline(mcmc_res_fle_sad)
```

## Plot coefficients

```{r coefs}
#### Total prey
# small cod total prey
small_cod_tot_pars <- bind_rows(tidy(s_cod_tot, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(s_cod_tot, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>%
  mutate(species = "Small cod",
         response = "Total prey")

# large cod total prey
large_cod_tot_pars <- bind_rows(tidy(l_cod_tot, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(l_cod_tot, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>% 
  mutate(species = "Large cod",
         response = "Total prey")

# flounder total prey
flounder_tot_pars <- bind_rows(tidy(fle_tot, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(fle_tot, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>% 
  mutate(species = "Flounder",
         response = "Total prey")

#### Benthic prey
# small cod benthic prey
small_cod_ben_pars <- bind_rows(tidy(s_cod_ben, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(s_cod_ben, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>% 
  mutate(species = "Small cod",
         response = "Benthic prey")

# large cod benthic prey
large_cod_ben_pars <- bind_rows(tidy(l_cod_ben, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(l_cod_ben, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>% 
  mutate(species = "Large cod",
         response = "Benthic prey")

# flounder benthic prey
flounder_ben_pars <- bind_rows(tidy(fle_ben, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(fle_ben, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>% 
  mutate(species = "Flounder",
         response = "Benthic prey")


#### Saduria
# small cod saduria
small_cod_sad_pars <- bind_rows(tidy(s_cod_sad, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(s_cod_sad, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>% 
  mutate(species = "Small cod",
         response = "Saduria")

# large cod saduria
large_cod_sad_pars <- bind_rows(tidy(l_cod_sad, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(l_cod_sad, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>% 
  mutate(species = "Large cod",
         response = "Saduria")

# flounder saduria
flounder_sad_pars <- bind_rows(tidy(fle_sad, effects = "fixed", conf.int = TRUE, model = 1) %>% 
                                  mutate(model = "Binomial"),
                                tidy(fle_sad, effects = "fixed", conf.int = TRUE, model = 2) %>% 
                                  mutate(model = "Lognormal")) %>% 
  mutate(species = "Flounder",
         response = "Saduria")

coefs <- bind_rows(small_cod_tot_pars,
                   large_cod_tot_pars,
                   flounder_tot_pars,
                      
                   small_cod_ben_pars,
                   large_cod_ben_pars,
                   flounder_ben_pars,
                   
                   small_cod_sad_pars,
                   large_cod_sad_pars,
                   flounder_sad_pars)

coefs <- coefs %>% 
  mutate(term2 = term,
         term2 = ifelse(term == "temp_sc", "Temperature", term2),
         term2 = ifelse(term == "oxy_sc", "Oxygen", term2),
         term2 = ifelse(term == "depth_sc", "Depth", term2),
         term2 = ifelse(term == "density_saduria_sc", "Saduria", term2),
         term2 = ifelse(term == "density_cod_large_sc", "Cod (> 29)", term2),
         term2 = ifelse(term == "density_cod_small_sc", "Cod (< 29)", term2),
         term2 = ifelse(term == "density_cod_small_sc:density_saduria_sc", "Cod (> 29) x Saduria", term2),
         term2 = ifelse(term == "density_flounder_sc:density_saduria_sc", "Flounder x Saduria", term2),
         term2 = ifelse(term == "density_cod_small_sc:density_saduria_sc", "Small cod x Saduria", term2),
         term2 = ifelse(term == "density_flounder_sc", "Flounder", term2))

coefs <- coefs %>% 
  mutate(sig = ifelse(estimate > 0 & conf.low > 0, "Y", "N"),
         sig = ifelse(estimate < 0 & conf.high < 0, "Y", sig))

# Plot
p1 <- coefs %>% 
  filter(!grepl('year', term)) %>% 
  filter(!grepl('quarter', term)) %>% 
  filter(model == "Binomial") %>% 
  filter(response == "Benthic prey") %>% 
  ggplot(aes(term2, estimate, color = species, fill = species, shape = sig)) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray50", size = 0.2) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0,
                position = position_dodge(width = 0.5), alpha = 0.65) +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_shape_manual(values = c(1, 21)) +
  guides(fill = "none") +
  facet_wrap(~ response) +
  labs(x = "", y = "Standardized coefficient", color = "Model", shape = "95% CI crossing 0") +
  theme(legend.position = "bottom",
        aspect.ratio = 1.3,
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  NULL 

p2 <- coefs %>% 
  filter(!grepl('year', term)) %>% 
  filter(!grepl('quarter', term)) %>% 
  filter(model == "Binomial") %>% 
  filter(response == "Saduria") %>% 
  ggplot(aes(term2, estimate, color = species, fill = species, shape = sig)) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray50", size = 0.2) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0,
                position = position_dodge(width = 0.5), alpha = 0.65) +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_shape_manual(values = c(1, 21)) +
  guides(fill = "none") +
  facet_wrap(~ response) +
  labs(x = "", y = "", color = "Model", shape = "95% CI crossing 0") +
  theme(legend.position = "bottom",
        aspect.ratio = 1.3,
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  NULL 

p3 <- coefs %>% 
  filter(!grepl('year', term)) %>% 
  filter(!grepl('quarter', term)) %>% 
  filter(model == "Binomial") %>% 
  filter(response == "Total prey") %>% 
  ggplot(aes(term2, estimate, color = species, fill = species, shape = sig)) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray50", size = 0.2) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0,
                position = position_dodge(width = 0.5), alpha = 0.65) +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_shape_manual(values = c(1, 21)) +
  guides(fill = "none") +
  facet_wrap(~ response) +
  labs(x = "", y = "", color = "Model", shape = "95% CI crossing 0") +
  theme(legend.position = "bottom",
        aspect.ratio = 1.3,
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  NULL 

(p1 + p2 + p3) + plot_layout(guides = "collect")

ggsave("figures/fr_coefs_binom.pdf", width = 17, height = 17, units = "cm")


p1 <- coefs %>% 
  filter(!grepl('year', term)) %>% 
  filter(!grepl('quarter', term)) %>% 
  filter(model == "Binomial") %>% 
  filter(response == "Benthic prey") %>% 
  ggplot(aes(term2, estimate, color = species, fill = species, shape = sig)) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray50", size = 0.2) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0,
                position = position_dodge(width = 0.5), alpha = 0.65) +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_shape_manual(values = c(1, 21)) +
  guides(fill = "none") +
  facet_wrap(~ response) +
  labs(x = "", y = "Standardized coefficient", color = "Model", shape = "95% CI crossing 0") +
  theme(legend.position = "bottom",
        aspect.ratio = 1.3,
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  NULL 

p2 <- coefs %>% 
  filter(!grepl('year', term)) %>% 
  filter(!grepl('quarter', term)) %>% 
  filter(model == "Binomial") %>% 
  filter(response == "Saduria") %>% 
  ggplot(aes(term2, estimate, color = species, fill = species, shape = sig)) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray50", size = 0.2) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0,
                position = position_dodge(width = 0.5), alpha = 0.65) +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_shape_manual(values = c(1, 21)) +
  guides(fill = "none") +
  facet_wrap(~ response) +
  labs(x = "", y = "", color = "Model", shape = "95% CI crossing 0") +
  theme(legend.position = "bottom",
        aspect.ratio = 1.3,
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  NULL 

p3 <- coefs %>% 
  filter(!grepl('year', term)) %>% 
  filter(!grepl('quarter', term)) %>% 
  filter(model == "Binomial") %>% 
  filter(response == "Total prey") %>% 
  ggplot(aes(term2, estimate, color = species, fill = species, shape = sig)) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray50", size = 0.2) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0,
                position = position_dodge(width = 0.5), alpha = 0.65) +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_shape_manual(values = c(1, 21)) +
  guides(fill = "none") +
  facet_wrap(~ response) +
  labs(x = "", y = "", color = "Model", shape = "95% CI crossing 0") +
  theme(legend.position = "bottom",
        aspect.ratio = 1.3,
        axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  NULL 

(p1 + p2 + p3) + plot_layout(guides = "collect")

ggsave("figures/fr_coefs_lognorm.pdf", width = 17, height = 17, units = "cm")


# Year effects
coefs %>% 
  filter(term %in% c("fyear2015", "fyear2016", "fyear2017", "fyear2018", "fyear2019", "fyear2020", "quarter")) %>% 
  mutate(term2 = ifelse(term == "fyear2015", "2015", term2),
         term2 = ifelse(term == "fyear2016", "2016", term2),
         term2 = ifelse(term == "fyear2017", "2017", term2),
         term2 = ifelse(term == "fyear2018", "2018", term2),
         term2 = ifelse(term == "fyear2019", "2019", term2),
         term2 = ifelse(term == "fyear2020", "2020", term2),
         term2 = ifelse(term == "quarter", "Quarter", term2)) %>% 
  filter(!term2 == "Quarter") %>% 
  ggplot(aes(term2, estimate, color = species)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0,
                position = position_dodge(width = 0.5)) +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  facet_grid(model~response) +
  labs(x = "Predictor", y = "Standardized coefficient") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90),
        aspect.ratio = 1.3) +
  NULL 

ggsave("figures/supp/fr_coefs_yr.pdf", width = 17, height = 17, units = "cm")
```

```{r flounder conditional effects}
# fle_sad <- sdmTMB(
#   data = flounder_stomach,
#   formula = saduria_feeding_ratio ~ 0 + fyear + quarter + temp_sc + depth_sc + density_cod_small_sc*oxy_sc + density_cod_large_sc + density_flounder_sc + (1|haul_id),
#   family = tweedie(link = "log"),
#   time = "year",
#   spatiotemporal = "off",
#   spatial = "off",
#   mesh = flounder_spde,
#   priors = sdmTMBpriors(
#     b = normal(c(rep(NA, 7), rep(0, 7)),
#                c(rep(NA, 7), rep(1, 7)))),
#   control = sdmTMBcontrol(newton_loops = 1)
#   )

# visreg_delta(s_cod_sad, xvar = "density_flounder_sc", model = 1, gg = TRUE, by = "oxy_sc")
# visreg_delta(s_cod_sad, xvar = "density_flounder_sc", model = 2, gg = TRUE)
# visreg_delta(s_cod_sad, xvar = "density_flounder_sc", model = 1, gg = TRUE, by = "oxy_sc")

hist(fle_sad$data$density_cod_small_sc)

fle1 <- visreg_delta(fle_sad,
                     xvar = "density_cod_small_sc",
                     model = 1,
                     plot = FALSE,
                     by = "density_saduria_sc",
                     breaks = c(-0.5, 0.5)
                     )

fle2 <- visreg_delta(fle_sad,
                     xvar = "density_cod_small_sc",
                     model = 2,
                     plot = FALSE,
                     by = "density_saduria_sc",
                     breaks = c(-0.5, 0.5))

scod1 <- visreg_delta(s_cod_sad,
                      xvar = "density_flounder_sc",
                      model = 1,
                      plot = FALSE,
                      by = "density_saduria_sc",
                      breaks = c(-0.5, 0.5))

scod2 <- visreg_delta(s_cod_sad,
                      xvar = "density_flounder_sc",
                      model = 2,
                      plot = FALSE,
                      by = "density_saduria_sc",
                      breaks = c(-0.5, 0.5))

lcod1 <- visreg_delta(l_cod_sad,
                      xvar = "density_flounder_sc",
                      model = 1,
                      plot = FALSE,
                      by = "density_saduria_sc",
                      breaks = c(-0.5, 0.5))

lcod2 <- visreg_delta(l_cod_sad,
                      xvar = "density_flounder_sc",
                      model = 2,
                      plot = FALSE,
                      by = "density_saduria_sc",
                      breaks = c(-0.5, 0.5))

visreg_fit <- bind_rows(fle1$fit %>% mutate(model = "fle1"),
                        fle2$fit %>% mutate(model = "fle2"),
                        scod1$fit %>% mutate(model = "scod1"),
                        scod2$fit %>% mutate(model = "scod2"),
                        lcod1$fit %>% mutate(model = "lcod1"),
                        lcod2$fit %>% mutate(model = "lcod2")
                        )

visreg_res <- bind_rows(fle1$res %>% mutate(model = "fle1"),
                        fle2$res %>% mutate(model = "fle2"),
                        scod1$res %>% mutate(model = "scod1"),
                        scod2$res %>% mutate(model = "scod2"),
                        lcod1$res %>% mutate(model = "lcod1"),
                        lcod2$res %>% mutate(model = "lcod2")
                        )

visreg_fit <- visreg_fit %>% 
  mutate(species = ifelse(model %in% c("fle1", "fle2"), "Flounder", NA),
         species = ifelse(model %in% c("scod1", "scod2"), "Small cod", species),
         species = ifelse(model %in% c("lcod1", "lcod2"), "Large cod", species)) %>% 
  mutate(model_comp = ifelse(model %in% c("fle1", "scod1", "lcod1"), "Binomial", "LogNormal"))

visreg_res <- visreg_res %>% 
  mutate(species = ifelse(model %in% c("fle1", "fle2"), "Flounder", NA),
         species = ifelse(model %in% c("scod1", "scod2"), "Small cod", species),
         species = ifelse(model %in% c("lcod1", "lcod2"), "Large cod", species)) %>% 
  mutate(model_comp = ifelse(model %in% c("fle1", "scod1", "lcod1"), "Binomial", "LogNormal"))

pal <- brewer.pal(n = 9, name = "Set3")[4:5]

# Flounder
p1 <- ggplot(visreg_fit %>% filter(species == "Flounder"),
             aes(x = density_cod_small_sc, y = visregFit, fill = factor(density_saduria_sc), color = factor(density_saduria_sc))) +
  facet_grid(model_comp ~ species) +
  geom_point(aes(y = visregRes), data = visreg_res %>% filter(species == "Flounder"), size = 1, alpha = 0.5) + 
  geom_ribbon(aes(ymin = visregLwr, ymax = visregUpr), alpha = 0.2, color = NA) +
  geom_line() +
  # scale_color_brewer(palette = "Set1") +
  # scale_fill_brewer(palette = "Set1") +
  # scale_color_brewer(palette = "Accent") +
  # scale_fill_brewer(palette = "Accent") +
  labs(x = "Small cod density (scaled)",
       color = "Saduria density (scaled)") +
  guides(fill = "none") +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
  theme(aspect.ratio = 1.1) +
  theme_plot(base_size = 6) +
  NULL

# Small cod
p2 <- ggplot(visreg_fit %>% filter(species == "Small cod"),
             aes(x = density_flounder_sc, y = visregFit, fill = factor(density_saduria_sc), color = factor(density_saduria_sc))) +
  #ggh4x::facet_grid2(model_comp ~ species, scales = "free_y", independent = "y") +
  facet_grid(model_comp ~ species) +
  geom_point(aes(y = visregRes), data = visreg_res %>% filter(species == "Small cod"), size = 1, alpha = 0.2) + 
  geom_ribbon(aes(ymin = visregLwr, ymax = visregUpr), alpha = 0.2, color = NA) +
  geom_line() +
  labs(x = "Flounder density (scaled)"#,
       #color = "Saduria density (scaled)"
       ) +
  guides(fill = "none",
         color = "none") +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
  theme(aspect.ratio = 1.1) +
  theme_plot(base_size = 6) +
  NULL

# Large cod
p3 <- ggplot(visreg_fit %>% filter(species == "Large cod"),
             aes(x = density_flounder_sc, y = visregFit, fill = factor(density_saduria_sc), color = factor(density_saduria_sc))) +
  #ggh4x::facet_grid2(model_comp ~ species, scales = "free_y", independent = "y") +
  #ggh4x::facet_grid2(model_comp ~ species, scales = "free_y", independent = "y") +
  facet_grid(model_comp ~ species) +
  geom_point(aes(y = visregRes), data = visreg_res %>% filter(species == "Large cod"), size = 1, alpha = 0.2) + 
  geom_ribbon(aes(ymin = visregLwr, ymax = visregUpr), alpha = 0.2, color = NA) +
  geom_line() +
  labs(x = "Flounder density (scaled)"#,
       #color = "Saduria density (scaled)"
       ) +
  guides(fill = "none",
         color = "none") +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
  theme(aspect.ratio = 1.1) +
  theme_plot(base_size = 6) +
  NULL

(p1 + p2 + p3) + plot_layout(guides = "collect")  & theme(aspect.ratio = 1)
  
# visreg_fit %>%
#   #filter(species == "Large cod") %>%
#   group_by(species, model) %>%
#   summarise(max_covar = max(density_flounder_sc),
#             min_covar = min(density_flounder_sc))

# Option 2
# ggplot(visreg_fit, aes(x = density_flounder_sc, y = visregFit, fill = factor(density_saduria_sc), color = factor(density_saduria_sc))) +
#   facet_grid2(model_comp ~ species) +
#   geom_ribbon(aes(ymin = visregLwr, ymax = visregUpr), alpha = 0.2, color = NA) +
#   geom_line() +
#   labs(x = "Flounder density (scaled)",
#        color = "Saduria density") +
#   guides(fill = "none") +
#   geom_point(aes(y = visregRes), data = visreg_res, size = 1, alpha = 0.2) + 
#   scale_color_brewer(palette ="Dark2") +
#   scale_fill_brewer(palette = "Dark2") +
#   theme(aspect.ratio = 1.1) +
#   NULL

ggsave("figures/conditional_saduria.pdf", width = 25, height = 16, units = "cm")
```



