---
title: "Fit density models to cod and flounder an check residual co-occurence"
author: "Max Lindmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro
In this script, I take the collated stomach data set and calculate aggregates (feeding ratio, total weight of prey groups) and predictor variables for diet data, aggregate to get 1 stomach = 1 row per prey type (not prey individual). I also select only the columns I need for model fitting, join environmental covariates and cpue covariates for cod and flounder, and lastly saduria biomass densities.

## Load packages & source functions

```{r load libraries, message=FALSE, warning=TRUE}
# Load libraries, install if needed
library(tidyverse)
library(readxl)
library(tidylog)
library(RCurl)
library(RColorBrewer)
library(patchwork)
library(janitor)
library(forcats)
library(gapminder)
library(viridis)
library(ggridges)
library(raster)
library(icesDatras)
library(ggalluvial)
library(ggrepel)
library(ncdf4)
library(chron)
library(rnaturalearth)
library(rnaturalearthdata)
library(mapplots)
library(geosphere)
library(quantreg)
library(brms)
library(sdmTMB)
library(sp)
library(raster)
library(ggcorrplot)
library(ggpubr)
options(mc.cores = parallel::detectCores()) 

# Source code for map plots
source("/Users/maxlindmark/Dropbox/Max work/R/cod_interactions/R/functions/map_plot.R")

theme_set(theme_plot())

# Continuous colors
options(ggplot2.continuous.colour = "viridis")

# Discrete colors
scale_colour_discrete <- function(...) {
  scale_colour_brewer(palette = "Dark2")
}

scale_fill_discrete <- function(...) {
  scale_fill_brewer(palette = "Dark2")
}
```

## Read and summarise data

```{r read data}
cpue_full <- readr::read_csv("data/clean/catch_by_length_q1_q4.csv") %>%
  janitor::clean_names() %>% 
  rename(X = x,
         Y = y) 

# Summaries density by species group an haul
cpue <- cpue_full %>%
  mutate(species2 = species,
         species2 = ifelse(species == "cod" & length_cm >= 25, "large_cod", species),
         species2 = ifelse(species == "cod" & length_cm < 25, "small_cod", species2)) %>% 
  group_by(haul_id, species2) %>% 
  summarise(density = sum(density)) %>% 
  ungroup()

# Trim data with quantiles
ggplot(cpue, aes(density)) + 
  geom_histogram() +
  facet_wrap(~species2, scales = "free")

cpue <- cpue %>% 
  group_by(species2) %>% 
  mutate(dens_quants = quantile(density, probs = 0.995)) %>% 
  filter(density < dens_quants) %>% 
  ungroup() %>% 
  dplyr::select(-dens_quants)

# Make wide
wcpue <- cpue %>% pivot_wider(names_from = species2, values_from = density)

head(wcpue)

# Left join in trawl information
nrow(wcpue)
hauls <- cpue_full %>% distinct(haul_id, .keep_all = TRUE) %>% dplyr::select(-density)
nrow(hauls)

cpue2 <- left_join(wcpue, hauls)

colnames(cpue2)

cpue2 <- cpue2 %>% drop_na(oxy, temp, depth, sal, substrate, flounder, small_cod, large_cod)

# Scale variables
cpue2 <- cpue2 %>% 
  mutate(depth_ct = depth - mean(depth),
         depth_sq = depth_ct * depth_ct,
         depth_sq_sc = (depth_sq - mean(depth_sq)) / sd(depth_sq),
         depth_sc = (depth - mean(depth)) / sd(depth),
         temp_ct = temp - mean(temp),
         temp_sq = temp_ct * temp_ct,
         temp_sq_sc = (temp_sq - mean(temp_sq)) / sd(temp_sq),
         temp_sc = (temp - mean(temp)) / sd(temp),
         oxy_sc = (oxy - mean(oxy)) / sd(oxy),
         sal_sc = (sal - mean(sal)) / sd(sal),
         fyear = as.factor(year),
         fsubstrate = as.factor(substrate))
```         

## Read and scale the prediction grid

```{r}
pred_grid_1 <- read_csv("data/clean/pred_grid_(1_2).csv")
pred_grid_2 <- read_csv("data/clean/pred_grid_(2_2).csv")

pred_grid <- bind_rows(pred_grid_1, pred_grid_2)

# Scale with respect to data!
pred_grid <- pred_grid %>% 
  drop_na(substrate) %>% 
  mutate(X = X / 1000,
         Y = Y / 1000,
         depth_ct = depth - mean(cpue2$depth),
         depth_sq = depth_ct * depth_ct,
         depth_sq_sc = (depth_sq - mean(cpue2$depth_sq)) / sd(cpue2$depth_sq),
         depth_sc = (depth - mean(cpue2$depth)) / sd(cpue2$depth),
         temp_ct = temp - mean(cpue2$temp),
         temp_sq = temp_ct * temp_ct,
         temp_sq_sc = (temp_sq - mean(cpue2$temp_sq)) / sd(cpue2$temp_sq),
         temp_sc = (temp - mean(cpue2$temp)) / sd(cpue2$temp),
         oxy_sc = (oxy - mean(cpue2$oxy)) / sd(cpue2$oxy),
         sal_sc = (sal - mean(cpue2$sal)) / sd(cpue2$sal),
         fyear = as.factor(year),
         fsubstrate = as.factor(substrate))

# Split by quarter
pred_grid_q1 <- pred_grid %>% filter(quarter == 1)
pred_grid_q4 <- pred_grid %>% filter(quarter == 4)
```

```{r}
# Load cache
# qwraps2::lazyload_cache_dir(path = "R/main_analysis/residual_cooccurence_cache/html")
```

## Plot data in space

```{r plot data}
hist(cpue2$depth)
hist(log(cpue2$depth))

cpue_long <- cpue2 %>%
  pivot_longer(c(flounder, small_cod, large_cod)) %>% 
  rename(species2 = name, density = value) %>% 
  pivot_longer(c(depth, temp, oxy, sal)) %>% 
  rename(env_var = name, env_var_value = value)

ggplot(cpue_long, aes(density)) + 
  geom_histogram() + 
  facet_wrap(~species2, scales = "free", ncol = 1)

ggplot(cpue_long, aes(env_var_value, density)) + 
  geom_point(alpha = 0.3) + 
  stat_smooth(method = "lm", formula = y ~ x, color = "blue", se = FALSE) + 
  stat_smooth(method = "lm", formula = y ~ x + I(x^2), color = "red", se = FALSE) + 
  facet_wrap(env_var~species2, scales = "free", ncol = 3) + 
  coord_cartesian(expand = 0)

cpue2 <- cpue2 %>% mutate(fle_presence = ifelse(flounder == 0, "N", "Y"),
                          l_cod_presence = ifelse(large_cod == 0, "N", "Y"),
                          s_cod_presence = ifelse(small_cod == 0, "N", "Y"))

# Biomass density
plot_map_fc + 
  geom_point(data = cpue2, aes(X*1000, Y*1000, color = flounder)) + 
  scale_color_viridis_c(trans = "sqrt") + 
  facet_wrap(~year)

plot_map_fc + 
  geom_point(data = cpue2, aes(X*1000, Y*1000, color = large_cod)) + 
  scale_color_viridis_c(trans = "sqrt") + 
  facet_wrap(~year)

plot_map_fc + 
  geom_point(data = cpue2, aes(X*1000, Y*1000, color = small_cod)) + 
  scale_color_viridis_c(trans = "sqrt") + 
  facet_wrap(~year)

# Presence / absence
plot_map_fc + 
  geom_point(data = cpue2, aes(X*1000, Y*1000, color = fle_presence)) + 
  facet_wrap(~year)

plot_map_fc + 
  geom_point(data = cpue2, aes(X*1000, Y*1000, color = l_cod_presence)) + 
  facet_wrap(~year)

plot_map_fc + 
  geom_point(data = cpue2, aes(X*1000, Y*1000, color = s_cod_presence)) + 
  facet_wrap(~year)
```
         
## Create meshes

```{r}
# Q1
spde_q1 <- make_mesh(filter(cpue2, quarter == 1),
                     xy_cols = c("X", "Y"),
                     n_knots = 150, 
                     type = "kmeans",
                     seed = 42)

# All flounder Q4
spde_q4 <- make_mesh(filter(cpue2, quarter == 4),
                     xy_cols = c("X", "Y"),
                     n_knots = 150, 
                     type = "kmeans",
                     seed = 42)
```

## Fit models
### q1
```{r small cod model q1, cache=TRUE}
# Small cod model q1
mcod_s_q1 <- sdmTMB(small_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                      temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                    data = filter(cpue2, quarter == 1),
                    mesh = spde_q1,
                    family = tweedie(link = "log"),
                    spatiotemporal = "off",
                    spatial = "off",
                    time = "year",
                    reml = FALSE,
                    control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_s_q1)
tidy(mcod_s_q1, conf.int = TRUE)
```

```{r small cod model q1 spatial, cache=TRUE}
# Small cod model q1 spatial
mcod_s_q1_space <- sdmTMB(small_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                            temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                          data = filter(cpue2, quarter == 1),
                          mesh = spde_q1,
                          family = tweedie(link = "log"),
                          spatiotemporal = "off",
                          spatial = "on",
                          time = "year",
                          reml = FALSE,
                          control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_s_q1_space)
tidy(mcod_s_q1_space, conf.int = TRUE)
```

```{r large cod model q1, cache=TRUE}
# Large cod model q1
mcod_l_q1 <- sdmTMB(large_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                      temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                    data = filter(cpue2, quarter == 1),
                    mesh = spde_q1,
                    family = tweedie(link = "log"),
                    spatiotemporal = "off",
                    spatial = "off",
                    time = "year",
                    reml = FALSE,
                    control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_l_q1)
tidy(mcod_l_q1, conf.int = TRUE)
```

```{r large cod model q1 spatial, cache=TRUE}
# Large cod model q1 spatial
mcod_l_q1_space <- sdmTMB(large_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                            temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                          data = filter(cpue2, quarter == 1),
                          mesh = spde_q1,
                          family = tweedie(link = "log"),
                          spatiotemporal = "off",
                          spatial = "on",
                          time = "year",
                          reml = FALSE,
                          control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_l_q1_space)
tidy(mcod_l_q1_space, conf.int = TRUE)
```

```{r flounder model q1, cache=TRUE}
# Flounder model q1
mfle_q1 <- sdmTMB(flounder ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                      temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                  data = filter(cpue2, quarter == 1),
                  mesh = spde_q1,
                  family = tweedie(link = "log"),
                  spatiotemporal = "off",
                  spatial = "off",
                  time = "year",
                  reml = FALSE,
                  control = sdmTMBcontrol(newton_loops = 1))

sanity(mfle_q1)
tidy(mfle_q1, conf.int = TRUE)
```

```{r flounder model q1 spatial, cache=TRUE}
# Flounder model q1 spatial
mfle_q1_space <- sdmTMB(flounder ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                          temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                        data = filter(cpue2, quarter == 1),
                        mesh = spde_q1,
                        family = tweedie(link = "log"),
                        spatiotemporal = "off",
                        spatial = "on",
                        time = "year",
                        reml = FALSE,
                        control = sdmTMBcontrol(newton_loops = 1))

sanity(mfle_q1_space)
tidy(mfle_q1_space, conf.int = TRUE)
```


### q4
```{r small cod model q4, cache=TRUE}
# Small cod model q4
mcod_s_q4 <- sdmTMB(small_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                      temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                    data = filter(cpue2, quarter == 4),
                    mesh = spde_q4,
                    family = tweedie(link = "log"),
                    spatiotemporal = "off",
                    spatial = "off",
                    time = "year",
                    reml = FALSE,
                    control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_s_q4)
tidy(mcod_s_q4, conf.int = TRUE)
```

```{r small cod model q4 spatial, cache=TRUE}
# Small cod model q4 spatial
mcod_s_q4_space <- sdmTMB(small_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                            temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                          data = filter(cpue2, quarter == 4),
                          mesh = spde_q4,
                          family = tweedie(link = "log"),
                          spatiotemporal = "off",
                          spatial = "on",
                          time = "year",
                          reml = FALSE,
                          control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_s_q4_space)
tidy(mcod_s_q4_space, conf.int = TRUE)
```

```{r large cod model q4, cache=TRUE}
# Large cod model q4
mcod_l_q4 <- sdmTMB(large_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                      temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                    data = filter(cpue2, quarter == 4),
                    mesh = spde_q4,
                    family = tweedie(link = "log"),
                    spatiotemporal = "off",
                    spatial = "off",
                    time = "year",
                    reml = FALSE,
                    control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_l_q4)
tidy(mcod_l_q4, conf.int = TRUE)
```

```{r large cod model q4 spatial, cache=TRUE}
# Large cod model q4 spatial
mcod_l_q4_space <- sdmTMB(large_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                            temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                          data = filter(cpue2, quarter == 4),
                          mesh = spde_q4,
                          family = tweedie(link = "log"),
                          spatiotemporal = "off",
                          spatial = "on",
                          time = "year",
                          reml = FALSE,
                          control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_l_q4_space)
tidy(mcod_l_q4_space, conf.int = TRUE)
```

```{r flounder model q4, cache=TRUE}
# Flounder model q4
mfle_q4 <- sdmTMB(flounder ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                      temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                  data = filter(cpue2, quarter == 4),
                  mesh = spde_q4,
                  family = tweedie(link = "log"),
                  spatiotemporal = "off",
                  spatial = "off",
                  time = "year",
                  reml = FALSE,
                  control = sdmTMBcontrol(newton_loops = 1))

sanity(mfle_q4)
tidy(mfle_q4, conf.int = TRUE)
```

```{r flounder model q4 spatial, cache=TRUE}
# Flounder model q4 spatial
mfle_q4_space <- sdmTMB(flounder ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                          temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                      data = filter(cpue2, quarter == 4),
                      mesh = spde_q4,
                      family = tweedie(link = "log"),
                      spatiotemporal = "off",
                      spatial = "on",
                      time = "year",
                      reml = FALSE,
                      control = sdmTMBcontrol(newton_loops = 1))

sanity(mfle_q4_space)
tidy(mfle_q4_space, conf.int = TRUE)
```

## Residuals in space

```{r}
cpue2_q1 <- filter(cpue2, quarter == 1)
cpue2_q4 <- filter(cpue2, quarter == 4)

cpue2_q1$res_small_cod <- residuals(mcod_s_q1)
cpue2_q1$res_large_cod <- residuals(mcod_l_q1)
cpue2_q1$res_flounder <- residuals(mfle_q1)

cpue2_q4$res_small_cod <- residuals(mcod_s_q4)
cpue2_q4$res_large_cod <- residuals(mcod_l_q4)
cpue2_q4$res_flounder <- residuals(mfle_q4)

cpue2_q1_long <- cpue2_q1 %>% pivot_longer(c(res_small_cod, res_large_cod, res_flounder))
cpue2_q4_long <- cpue2_q4 %>% pivot_longer(c(res_small_cod, res_large_cod, res_flounder))
  
res_long <- bind_rows(cpue2_q1_long, cpue2_q4_long) %>%
  rename(species2 = name) %>% 
  mutate(species2 = ifelse(species2 == "res_flounder", "Flounder", species2),
         species2 = ifelse(species2 == "res_large_cod", "Large cod", species2),
         species2 = ifelse(species2 == "res_small_cod", "Small cod", species2))

plot_map_fc + 
  geom_point(data = filter(res_long, year == 1999), aes(X*1000, Y*1000, color = value), size = 2) + 
  facet_grid(quarter ~ species2) + 
  scale_color_gradient2(name = "Residuals")

ggsave("figures/supp/residuals_in_space.pdf", width = 20, height = 20, units = "cm")
```

## Residual correlations

Raw correlation plot

```{r raw corr plot}
# Plot correlation between variables
d_cor_q1 <- cpue2_q1 %>% dplyr::select(res_small_cod, res_large_cod, res_flounder)

d_cor_q4 <- cpue2_q4 %>% dplyr::select(res_small_cod, res_large_cod, res_flounder)

p1 <- ggplot(d_cor_q1, aes(res_large_cod, res_flounder)) + 
  geom_point(alpha = 0.2) + 
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Large cod", y = "Flounder") +
  stat_cor(aes(label = ..r.label..), color = "red") +
  ggtitle("Quarter 1")

p2 <- ggplot(d_cor_q1, aes(res_small_cod, res_flounder)) + 
  geom_point(alpha = 0.2) +
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Small cod", y = "Flounder") +
  stat_cor(aes(label = ..r.label..), color = "red")

p3 <- ggplot(d_cor_q1, aes(res_large_cod, res_small_cod)) + 
  geom_point(alpha = 0.2) +
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Large cod", y = "Small cod") +
  stat_cor(aes(label = ..r.label..), color = "red")

p4 <- ggplot(d_cor_q4, aes(res_large_cod, res_flounder)) + 
  geom_point(alpha = 0.2) + 
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Large cod", y = "Flounder") +
  stat_cor(aes(label = ..r.label..), color = "red") +
  ggtitle("Quarter 4")

p5 <- ggplot(d_cor_q4, aes(res_small_cod, res_flounder)) + 
  geom_point(alpha = 0.2) +
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Small cod", y = "Flounder") +
  stat_cor(aes(label = ..r.label..), color = "red")

p6 <- ggplot(d_cor_q4, aes(res_large_cod, res_small_cod)) + 
  geom_point(alpha = 0.2) +
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Large cod", y = "Small cod") +
  stat_cor(aes(label = ..r.label..), color = "red")

pp1 <- (p1 | p2 | p3) & theme(aspect.ratio = 1)
pp4 <- (p4 | p5 | p6) & theme(aspect.ratio = 1)

pp1 / pp4

ggsave("figures/raw_residuals.pdf", width = 22, height = 16, units = "cm")
```

corplot

```{r cor plot heat}
corr_q1 <- round(cor(d_cor_q1), 3)
corr_q4 <- round(cor(d_cor_q4), 3)

pal <- brewer.pal(n = 3, name = "RdYlBu")

p1 <- ggcorrplot(corr_q1, hc.order = TRUE, type = "full", lab = TRUE, lab_size = 2.5,
                 #colors = c("steelblue", "white", "tomato")
                 colors = c(pal[3], "white", pal[1])) +
  theme_minimal(base_size = 11) + 
  labs(x = "", y = "") + 
  ggtitle("Quarter 1")

p4 <- ggcorrplot(corr_q4, hc.order = TRUE, type = "full", lab = TRUE, lab_size = 2.5,
                 #colors = c("steelblue", "white", "tomato")) +
                 colors = c(pal[3], "white", pal[1])) +
  theme_minimal(base_size = 11) + 
  labs(x = "", y = "") + 
  ggtitle("Quarter 4")

p1 + p4 + plot_layout(guides = "collect") & theme(legend.position = 'right')

ggsave("figures/supp/residu_corr.pdf", width = 20, height = 20, unit = "cm")
```

Residuals by subdiv

```{r cor plot heat by sd q4}
d_cor_q4 <- cpue2_q4 %>% dplyr::select(res_small_cod, res_large_cod, res_flounder, sub_div)

unique(d_cor_q4$sub_div)

d_cor_q4_24 <- d_cor_q4 %>% filter(sub_div == 24) %>% dplyr::select(-sub_div)
d_cor_q4_25 <- d_cor_q4 %>% filter(sub_div == 25) %>% dplyr::select(-sub_div)
d_cor_q4_26 <- d_cor_q4 %>% filter(sub_div == 26) %>% dplyr::select(-sub_div)
d_cor_q4_27 <- d_cor_q4 %>% filter(sub_div == 27) %>% dplyr::select(-sub_div)
d_cor_q4_28 <- d_cor_q4 %>% filter(sub_div == 28) %>% dplyr::select(-sub_div)

corr_q4_24 <- round(cor(d_cor_q4_24), 3)
corr_q4_25 <- round(cor(d_cor_q4_25), 3)
corr_q4_26 <- round(cor(d_cor_q4_26), 3)
corr_q4_27 <- round(cor(d_cor_q4_27), 3)
corr_q4_28 <- round(cor(d_cor_q4_28), 3)

pal <- brewer.pal(n = 3, name = "RdYlBu")

p1 <- ggcorrplot(corr_q4_24, hc.order = TRUE, type = "full", lab = TRUE, lab_size = 2.5,
                 colors = c(pal[3], "white", pal[1])) +
  theme_minimal(base_size = 11) + 
  labs(x = "", y = "") + 
  ggtitle("Subdivision 24")
  
p2 <- ggcorrplot(corr_q4_25, hc.order = TRUE, type = "full", lab = TRUE, lab_size = 2.5,
                 colors = c(pal[3], "white", pal[1])) +
  theme_minimal(base_size = 11) + 
  labs(x = "", y = "") + 
  ggtitle("Subdivision 25")

p3 <- ggcorrplot(corr_q4_26, hc.order = TRUE, type = "full", lab = TRUE, lab_size = 2.5,
                 colors = c(pal[3], "white", pal[1])) +
  theme_minimal(base_size = 11) + 
  labs(x = "", y = "") + 
  ggtitle("Subdivision 26")


# p4 <- ggcorrplot(corr_q4_27, hc.order = TRUE, type = "full", lab = TRUE, lab_size = 2.5,
#                  colors = c(pal[3], "white", pal[1])) +
#   theme_minimal(base_size = 11) + 
#   labs(x = "", y = "") + 
#   ggtitle("Subdivision 27")

p5 <- ggcorrplot(corr_q4_28, hc.order = TRUE, type = "full", lab = TRUE, lab_size = 2.5,
                 colors = c(pal[3], "white", pal[1])) +
  theme_minimal(base_size = 11) + 
  labs(x = "", y = "") + 
  ggtitle("Subdivision 28")

#(p1 + p2 + p3) / (p4 + p5 + plot_spacer()) + plot_layout(guides = "collect") & theme(legend.position = 'bottom')
(p1 + p2 ) / (p3 + p5) + plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ggsave("figures/supp/residu_corr_subdiv.pdf", width = 20, height = 20, unit = "cm")

cpue2 %>% 
  group_by(sub_div) %>% 
  summarise(n = n())
```

raw correlation by ices rectangle!

```{r}
d_cor_q4 <- cpue2_q4 %>%
  dplyr::select(res_small_cod,
                res_large_cod,
                res_flounder,
                #ices_rect,
                sub_div,
                flounder, 
                small_cod,
                large_cod,
                year) %>% 
  #mutate(year_rect = paste(year, ices_rect, sep = "_"))
  mutate(year_sd = paste(year, sub_div, sep = "_"))


d_cor_q4_sum <- cpue2_q4 %>%
  dplyr::select(res_small_cod,
                res_large_cod,
                res_flounder,
                #ices_rect,
                sub_div,
                flounder, 
                small_cod,
                large_cod,
                year) %>% 
  #mutate(year_rect = paste(year, ices_rect, sep = "_")) %>%
  mutate(year_sd = paste(year, sub_div, sep = "_")) %>% 
  #group_by(year_rect) %>%
  group_by(year_sd) %>% 
  summarise(res_small_cod = mean(res_small_cod),
            res_large_cod = mean(res_large_cod),
            res_flounder = mean(res_flounder),
            #ices_rect = head(ices_rect, 1),
            sub_div = head(sub_div, 1),
            flounder_dens = mean(log(flounder + 1)),
            small_cod_dens = mean(log(small_cod + 1)),
            large_cod_dens = mean(log(large_cod + 1)),
            year = head(year, 1)) %>% 
  ungroup() %>% 
  mutate(index = row_number())

d_cor_q4_sum

data_list <- list()

#for(i in unique(d_cor_q4_sum$year_rect)){
for(i in unique(d_cor_q4_sum$year_sd)){

  # dd <- filter(d_cor_q4, year_rect == i)
  # ddd <- filter(d_cor_q4_sum, year_rect == i)
  
  dd <- filter(d_cor_q4, year_sd == i)
  ddd <- filter(d_cor_q4_sum, year_sd == i)
  
  cor_df <- round(cor(dd[1:3]), 3)
  
  cor_df2 <- data.frame(small_cod_large_cod = cor_df[1, 2],
                        small_cod_flounder = cor_df[1, 3],
                        large_cod_flounder = cor_df[2, 3])
  
  #cor_df2$year_rect <- i
  cor_df2$year_sd <- i
  cor_df2$year <- ddd$year
  #cor_df2$ices_rect <- ddd$ices_rect
  cor_df2$sub_div <- ddd$sub_div
  cor_df2$flounder <- ddd$flounder_dens
  cor_df2$small_cod <- ddd$small_cod_dens
  cor_df2$large_cod <- ddd$large_cod_dens
  
  data_list[[ddd$index]] <- cor_df2

}

big_dat <- dplyr::bind_rows(data_list)

big_dat$flounder_plus_small_cod <- big_dat$flounder + big_dat$small_cod
big_dat$flounder_plus_large_cod <- big_dat$flounder + big_dat$large_cod

ggplot(filter(big_dat, small_cod_flounder > -1 & small_cod_flounder < 1),
       aes(flounder_plus_small_cod, small_cod_flounder)) + 
  geom_point()

ggplot(filter(big_dat, large_cod_flounder > -1 & large_cod_flounder < 1),
       aes(flounder_plus_large_cod, large_cod_flounder)) + 
  geom_point()
```

```{r raw corr spatial model plot}
mcod_s_q1_pred <- predict(mcod_s_q1_space, newdata = pred_grid_q1)
mcod_l_q1_pred <- predict(mcod_l_q1_space, newdata = pred_grid_q1)
mfle_q1_pred <- predict(mfle_q1_space, newdata = pred_grid_q1)

mcod_s_q4_pred <- predict(mcod_s_q4_space, newdata = pred_grid_q4)
mcod_l_q4_pred <- predict(mcod_l_q4_space, newdata = pred_grid_q4)
mfle_q4_pred <- predict(mfle_q4_space, newdata = pred_grid_q4)

omega_plot <- bind_rows(mcod_s_q1_pred %>% mutate(species = "Cod < 25 cm"),
                        mcod_s_q4_pred %>% mutate(species = "Cod < 25 cm"),
                        mcod_l_q1_pred %>% mutate(species = "Cod > 25 cm"),
                        mcod_l_q4_pred %>% mutate(species = "Cod > 25 cm"),
                        mcod_l_q1_pred %>% mutate(species = "Flounder"),
                        mcod_l_q4_pred %>% mutate(species = "Flounder"))


plot_map +
  geom_raster(data = filter(omega_plot, year == 1999),
              aes(X*1000, Y*1000, fill = omega_s)) +
  facet_grid(quarter ~ species) +
  scale_fill_gradient2()

ggsave("figures/supp/omega_random_field.pdf", width = 20, height = 20, units = "cm")

# Now plot residual correlation
cpue2_spatial_q1 <- filter(cpue2, quarter == 1)
cpue2_spatial_q4 <- filter(cpue2, quarter == 4)

cpue2_spatial_q1$res_small_cod <- residuals(mcod_s_q1_space)
cpue2_spatial_q1$res_large_cod <- residuals(mcod_l_q1_space)
cpue2_spatial_q1$res_flounder <- residuals(mfle_q1_space)

cpue2_spatial_q4$res_small_cod <- residuals(mcod_s_q4_space)
cpue2_spatial_q4$res_large_cod <- residuals(mcod_l_q4_space)
cpue2_spatial_q4$res_flounder <- residuals(mfle_q4_space)

# Plot correlation between variables
d_cor_q1_spatial <- cpue2_spatial_q1 %>% dplyr::select(res_small_cod,
                                                       res_large_cod, 
                                                       res_flounder)

d_cor_q4_spatial <- cpue2_spatial_q1 %>% dplyr::select(res_small_cod,
                                                       res_large_cod,
                                                       res_flounder)

# min(d_cor_q4$res_small_cod, d_cor_q4$res_large_cod, d_cor_q4$res_flounder)
# max(d_cor_q4$res_small_cod, d_cor_q4$res_large_cod, d_cor_q4$res_flounder)

p1 <- ggplot(d_cor_q1_spatial, aes(res_large_cod, res_flounder)) + 
  geom_point(alpha = 0.2) + 
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Large cod", y = "Flounder") +
  stat_cor(aes(label = ..r.label..), color = "red") +
  ggtitle("Quarter 1")

p2 <- ggplot(d_cor_q1_spatial, aes(res_small_cod, res_flounder)) + 
  geom_point(alpha = 0.2) +
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Small cod", y = "Flounder") +
  stat_cor(aes(label = ..r.label..), color = "red")

p3 <- ggplot(d_cor_q1_spatial, aes(res_large_cod, res_small_cod)) + 
  geom_point(alpha = 0.2) +
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Large cod", y = "Small cod") +
  stat_cor(aes(label = ..r.label..), color = "red")

p4 <- ggplot(d_cor_q4_spatial, aes(res_large_cod, res_flounder)) + 
  geom_point(alpha = 0.2) + 
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Large cod", y = "Flounder") +
  stat_cor(aes(label = ..r.label..), color = "red") + 
  ggtitle("Quarter 4")

p5 <- ggplot(d_cor_q4_spatial, aes(res_small_cod, res_flounder)) + 
  geom_point(alpha = 0.2) +
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Small cod", y = "Flounder") +
  stat_cor(aes(label = ..r.label..), color = "red")

p6 <- ggplot(d_cor_q4_spatial, aes(res_large_cod, res_small_cod)) + 
  geom_point(alpha = 0.2) +
  xlim(-6, 6) +
  ylim(-6, 6) +
  labs(x = "Large cod", y = "Small cod") +
  stat_cor(aes(label = ..r.label..), color = "red")

pp1 <- (p1 | p2 | p3) & theme(aspect.ratio = 1)
pp4 <- (p4 | p5 | p6) & theme(aspect.ratio = 1)

(pp1 / pp4)

ggsave("figures/supp/raw_residuals_spatial_model.pdf", width = 22, height = 16, units = "cm")
```

 