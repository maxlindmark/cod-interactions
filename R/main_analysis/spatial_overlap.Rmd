---
title: "Fit density models to cod and flounder and check spatial overlap"
author: "Max Lindmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro
In this script, I take the collated stomach data set and calculate aggregates (feeding ratio, total weight of prey groups) and predictor variables for diet data, aggregate to get 1 stomach = 1 row per prey type (not prey individual). I also select only the columns I need for model fitting, join environmental covariates and cpue covariates for cod and flounder, and lastly saduria biomass densities.

## Load packages & source functions

```{r load libraries, message=FALSE, warning=TRUE}
# Load libraries, install if needed
library(tidyverse)
library(readxl)
library(tidylog)
library(RCurl)
library(RColorBrewer)
library(patchwork)
library(janitor)
library(forcats)
library(gapminder)
library(viridis)
library(ggridges)
library(raster)
library(icesDatras)
library(ggalluvial)
library(ggrepel)
library(ncdf4)
library(chron)
library(rnaturalearth)
library(rnaturalearthdata)
library(mapplots)
library(geosphere)
library(quantreg)
library(brms)
library(sdmTMB)
library(sp)
library(raster)
library(ggcorrplot)
library(ggh4x)
options(mc.cores = parallel::detectCores()) 

# Source code for map plots
source("/Users/maxlindmark/Dropbox/Max work/R/cod_interactions/R/functions/map_plot.R")

theme_set(theme_plot())

# Continuous colors
options(ggplot2.continuous.colour = "viridis")

# Discrete colors
scale_colour_discrete <- function(...) {
  scale_colour_brewer(palette = "Dark2")
}

scale_fill_discrete <- function(...) {
  scale_fill_brewer(palette = "Dark2")
}
```

## Read and summarise data

```{r read data}
cpue_full <- readr::read_csv("data/clean/catch_by_length_q1_q4.csv") %>%
  janitor::clean_names() %>% 
  rename(X = x,
         Y = y) 

# Summaries density by species group an haul
cpue <- cpue_full %>%
  mutate(species2 = species,
         species2 = ifelse(species == "cod" & length_cm >= 25, "large_cod", species),
         species2 = ifelse(species == "cod" & length_cm < 25, "small_cod", species2)) %>% 
  group_by(haul_id, species2) %>% 
  summarise(density = sum(density)) %>% 
  ungroup()

# Trim data with quantiles
ggplot(cpue, aes(density)) + 
  geom_histogram() +
  facet_wrap(~species2, scales = "free")

cpue <- cpue %>% 
  group_by(species2) %>% 
  mutate(dens_quants = quantile(density, probs = 0.999)) %>% 
  filter(density < dens_quants) %>% 
  ungroup() %>% 
  dplyr::select(-dens_quants)

# Make wide
wcpue <- cpue %>% pivot_wider(names_from = species2, values_from = density)

head(wcpue)

# Left join in trawl information
nrow(wcpue)
hauls <- cpue_full %>% distinct(haul_id, .keep_all = TRUE) %>% dplyr::select(-density)
nrow(hauls)

cpue2 <- left_join(wcpue, hauls)

colnames(cpue2)

cpue2 <- cpue2 %>% drop_na(oxy, temp, depth, sal, substrate, flounder, small_cod, large_cod)

# Scale variables
cpue2 <- cpue2 %>% 
  mutate(depth_ct = depth - mean(depth),
         depth_sq = depth_ct * depth_ct,
         depth_sq_sc = (depth_sq - mean(depth_sq)) / sd(depth_sq),
         depth_sc = (depth - mean(depth)) / sd(depth),
         temp_ct = temp - mean(temp),
         temp_sq = temp_ct * temp_ct,
         temp_sq_sc = (temp_sq - mean(temp_sq)) / sd(temp_sq),
         temp_sc = (temp - mean(temp)) / sd(temp),
         oxy_sc = (oxy - mean(oxy)) / sd(oxy),
         sal_sc = (sal - mean(sal)) / sd(sal),
         fyear = as.factor(year),
         fsubstrate = as.factor(substrate))
```         

## Read and scale the prediction grid

```{r}
pred_grid_1 <- read_csv("data/clean/pred_grid_(1_2).csv")
pred_grid_2 <- read_csv("data/clean/pred_grid_(2_2).csv")

pred_grid <- bind_rows(pred_grid_1, pred_grid_2)

# Scale with respect to data!
pred_grid <- pred_grid %>% 
  drop_na(substrate) %>% 
  mutate(X = X / 1000,
         Y = Y / 1000,
         depth_ct = depth - mean(cpue2$depth),
         depth_sq = depth_ct * depth_ct,
         depth_sq_sc = (depth_sq - mean(cpue2$depth_sq)) / sd(cpue2$depth_sq),
         depth_sc = (depth - mean(cpue2$depth)) / sd(cpue2$depth),
         temp_ct = temp - mean(cpue2$temp),
         temp_sq = temp_ct * temp_ct,
         temp_sq_sc = (temp_sq - mean(cpue2$temp_sq)) / sd(cpue2$temp_sq),
         temp_sc = (temp - mean(cpue2$temp)) / sd(cpue2$temp),
         oxy_sc = (oxy - mean(cpue2$oxy)) / sd(cpue2$oxy),
         sal_sc = (sal - mean(cpue2$sal)) / sd(cpue2$sal),
         fyear = as.factor(year),
         fsubstrate = as.factor(substrate))

# Split by quarter
pred_grid_q1 <- pred_grid %>% filter(quarter == 1)
pred_grid_q4 <- pred_grid %>% filter(quarter == 4)
```

```{r}
# Load models
# qwraps2::lazyload_cache_dir(path = "R/main_analysis/spatial_overlap_cache/html")
```

## Plot data in space

```{r plot data}
# hist(cpue2$depth)
# hist(log(cpue2$depth))
# 
# cpue_long <- cpue2 %>%
#   pivot_longer(c(flounder, small_cod, large_cod)) %>% 
#   rename(species2 = name, density = value) %>% 
#   pivot_longer(c(depth, temp, oxy, sal)) %>% 
#   rename(env_var = name, env_var_value = value)
# 
# ggplot(cpue_long, aes(density)) + 
#   geom_histogram() + 
#   facet_wrap(~species2, scales = "free", ncol = 1)
# 
# ggplot(cpue_long, aes(env_var_value, density)) + 
#   geom_point(alpha = 0.3) + 
#   stat_smooth(method = "lm", formula = y ~ x, color = "blue", se = FALSE) + 
#   stat_smooth(method = "lm", formula = y ~ x + I(x^2), color = "red", se = FALSE) + 
#   facet_wrap(env_var~species2, scales = "free", ncol = 3) + 
#   coord_cartesian(expand = 0)
# 
# cpue2 <- cpue2 %>% mutate(fle_presence = ifelse(flounder == 0, "N", "Y"),
#                           l_cod_presence = ifelse(large_cod == 0, "N", "Y"),
#                           s_cod_presence = ifelse(small_cod == 0, "N", "Y"))
# 
# # Biomass density
# plot_map_fc + 
#   geom_point(data = cpue2, aes(X*1000, Y*1000, color = flounder)) + 
#   scale_color_viridis_c(trans = "sqrt") + 
#   facet_wrap(~year)
# 
# plot_map_fc + 
#   geom_point(data = cpue2, aes(X*1000, Y*1000, color = large_cod)) + 
#   scale_color_viridis_c(trans = "sqrt") + 
#   facet_wrap(~year)
# 
# plot_map_fc + 
#   geom_point(data = cpue2, aes(X*1000, Y*1000, color = small_cod)) + 
#   scale_color_viridis_c(trans = "sqrt") + 
#   facet_wrap(~year)
# 
# # Presence / absence
# plot_map_fc + 
#   geom_point(data = cpue2, aes(X*1000, Y*1000, color = fle_presence)) + 
#   facet_wrap(~year)
# 
# plot_map_fc + 
#   geom_point(data = cpue2, aes(X*1000, Y*1000, color = l_cod_presence)) + 
#   facet_wrap(~year)
# 
# plot_map_fc + 
#   geom_point(data = cpue2, aes(X*1000, Y*1000, color = s_cod_presence)) + 
#   facet_wrap(~year)
```
         
## Create meshes

```{r}
# Q1
spde_q1 <- make_mesh(filter(cpue2, quarter == 1),
                     xy_cols = c("X", "Y"),
                     n_knots = 150, 
                     type = "kmeans",
                     seed = 42)

# All flounder Q4
spde_q4 <- make_mesh(filter(cpue2, quarter == 4),
                     xy_cols = c("X", "Y"),
                     n_knots = 150, 
                     type = "kmeans",
                     seed = 42)
```

## Fit models
### q1

```{r small cod model q1 spatial, cache=TRUE}
# Small cod model q1 spatial
mcod_s_q1_space <- sdmTMB(small_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                            temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                          data = filter(cpue2, quarter == 1),
                          mesh = spde_q1,
                          family = tweedie(link = "log"),
                          spatiotemporal = "IID",
                          spatial = "on",
                          time = "year",
                          reml = FALSE,
                          control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_s_q1_space)
tidy(mcod_s_q1_space, conf.int = TRUE)
```

```{r large cod model q1 spatial, cache=TRUE}
# Large cod model q1 spatial
mcod_l_q1_space <- sdmTMB(large_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                            temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                          data = filter(cpue2, quarter == 1),
                          mesh = spde_q1,
                          family = tweedie(link = "log"),
                          spatiotemporal = "IID",
                          spatial = "on",
                          time = "year",
                          reml = FALSE,
                          control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_l_q1_space)
tidy(mcod_l_q1_space, conf.int = TRUE)
```

```{r flounder model q1 spatial, cache=TRUE}
# Flounder model q1 spatial
mfle_q1_space <- sdmTMB(flounder ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                          temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                        data = filter(cpue2, quarter == 1),
                        mesh = spde_q1,
                        family = tweedie(link = "log"),
                        spatiotemporal = "IID",
                        spatial = "on",
                        time = "year",
                        reml = FALSE,
                        control = sdmTMBcontrol(newton_loops = 1))

sanity(mfle_q1_space)
tidy(mfle_q1_space, conf.int = TRUE)
```

### q4

```{r small cod model q4 spatial, cache=TRUE}
# Small cod model q4 spatial
mcod_s_q4_space <- sdmTMB(small_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                            temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                          data = filter(cpue2, quarter == 4),
                          mesh = spde_q4,
                          family = tweedie(link = "log"),
                          spatiotemporal = "IID",
                          spatial = "on",
                          time = "year",
                          reml = FALSE,
                          control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_s_q4_space)
tidy(mcod_s_q4_space, conf.int = TRUE)
```

```{r large cod model q4 spatial, cache=TRUE}
# Large cod model q4 spatial
mcod_l_q4_space <- sdmTMB(large_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                            temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                          data = filter(cpue2, quarter == 4),
                          mesh = spde_q4,
                          family = tweedie(link = "log"),
                          spatiotemporal = "IID",
                          spatial = "on",
                          time = "year",
                          reml = FALSE,
                          control = sdmTMBcontrol(newton_loops = 1))

sanity(mcod_l_q4_space)
tidy(mcod_l_q4_space, conf.int = TRUE)
```

```{r flounder model q4 spatial, cache=TRUE}
# Flounder model q4 spatial
mfle_q4_space <- sdmTMB(flounder ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                          temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                      data = filter(cpue2, quarter == 4),
                      mesh = spde_q4,
                      family = tweedie(link = "log"),
                      spatiotemporal = "IID",
                      spatial = "on",
                      time = "year",
                      reml = FALSE,
                      control = sdmTMBcontrol(newton_loops = 1))

sanity(mfle_q4_space)
tidy(mfle_q4_space, conf.int = TRUE)
```

## Plot coefficients

```{r coefs}
# Q1
# small cod
small_cod_q1 <- tidy(mcod_s_q1_space, effects = "fixed", conf.int = TRUE) %>%
  mutate(species = "Small cod",
         quarter = 1)

# large cod
large_cod_q1 <- tidy(mcod_l_q1_space, effects = "fixed", conf.int = TRUE) %>%
  mutate(species = "Large cod",
         quarter = 1)

# flounder
flounder_q1 <- tidy(mfle_q1_space, effects = "fixed", conf.int = TRUE) %>%
  mutate(species = "Flounder",
         quarter = 1)

# Q4
# small cod
small_cod_q4 <- tidy(mcod_s_q4_space, effects = "fixed", conf.int = TRUE) %>%
  mutate(species = "Small cod",
         quarter = 4)

# large cod
large_cod_q4 <- tidy(mcod_l_q4_space, effects = "fixed", conf.int = TRUE) %>%
  mutate(species = "Large cod",
         quarter = 4)

# flounder
flounder_q4 <- tidy(mfle_q4_space, effects = "fixed", conf.int = TRUE) %>%
  mutate(species = "Flounder",
         quarter = 4)


coefs <- bind_rows(small_cod_q1,
                   large_cod_q1,
                   flounder_q1,
                      
                   small_cod_q4,
                   large_cod_q4,
                   flounder_q4) %>% 
  mutate(param_group = ifelse(term %in% c("fsubstratebedrock",
                                          "fsubstratehard clay",
                                          "fsubstratehard-bottom complex",
                                          "fsubstratemud",
                                          "fsubstratesand"),
                              "Substrate",
                              "Continious")) %>% 
  mutate(term = ifelse(term == "fsubstratebedrock", "Bedrock", term),
         term = ifelse(term == "fsubstratehard clay", "Hard clay", term),
         term = ifelse(term == "fsubstratehard-bottom complex", "Hard-bottom\ncomplex", term),
         term = ifelse(term == "fsubstratemud", "Mud", term),
         term = ifelse(term == "fsubstratesand", "Sand", term),
         term = ifelse(term == "depth_sc", "Depth", term),
         term = ifelse(term == "depth_sq_sc", "Depth^2", term),
         term = ifelse(term == "temp_sc", "Temperature", term),
         term = ifelse(term == "temp_sq_sc", "Temperature^2", term),
         term = ifelse(term == "oxy_sc", "Oxygen", term),
         term = ifelse(term == "sal_sc", "Salinity", term))

coefs %>% 
  filter(!grepl('year', term)) %>% 
  ggplot(aes(term, estimate, color = species, shape = factor(quarter))) +
  geom_hline(yintercept = 0, linetype = 2, color = "gray50", size = 0.2) +
  geom_point(position = position_dodge(width = 0.5), size = 2) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0,
                position = position_dodge(width = 0.5)) +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  labs(shape = "Quarter") + 
  facet_wrap(~param_group, scales = "free") +
  labs(x = "Predictor", y = "Standardized coefficient") +
  theme_plot() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90),
        aspect.ratio = 1) +
  NULL 

ggsave("figures/habitat_coefs.pdf", width = 20, height = 20, units = "cm")
```

## Predict on grid

```{r, cache=TRUE}
mcod_s_q1_pred <- predict(mcod_s_q1_space, newdata = pred_grid_q1)
mcod_s_q4_pred <- predict(mcod_s_q4_space, newdata = pred_grid_q4)

mcod_l_q1_pred <- predict(mcod_l_q1_space, newdata = pred_grid_q1)
mcod_l_q4_pred <- predict(mcod_l_q4_space, newdata = pred_grid_q4)

mfle_q1_pred <- predict(mfle_q1_space, newdata = pred_grid_q1)
mfle_q4_pred <- predict(mfle_q4_space, newdata = pred_grid_q4)
```

Plot predictions on map

```{r}
p1 <- plot_map + 
  geom_raster(data = bind_rows(mcod_s_q1_pred, mcod_s_q4_pred) %>%
                filter(year %in% c("1995", "2019")),
              aes(X*1000, Y*1000, fill = exp(est))) +
  facet_grid(quarter~year) +
  ggtitle("Cod < 25 cm") +
  scale_fill_viridis(trans = "sqrt")

p2 <- plot_map + 
  geom_raster(data = bind_rows(mcod_l_q1_pred, mcod_l_q4_pred) %>%
                filter(year %in% c("1995", "2019")),
              aes(X*1000, Y*1000, fill = exp(est))) +
  facet_grid(quarter~year) +
  ggtitle("Cod > 25 cm") +
  scale_fill_viridis(trans = "sqrt")

p3 <- plot_map + 
  geom_raster(data = bind_rows(mfle_q1_pred, mfle_q4_pred) %>%
                filter(year %in% c("1995", "2019")),
              aes(X*1000, Y*1000, fill = exp(est))) +
  facet_grid(quarter~year) +
  ggtitle("Flounder") +
  scale_fill_viridis(trans = "sqrt")

((p1 + p2) / (p3 + plot_spacer())) + plot_annotation(tag_levels = "A") &
  theme(legend.text = element_text(angle = 90))

# Check flounder...

plot_map + 
  geom_raster(data = mfle_q1_pred,
              aes(X*1000, Y*1000, fill = exp(est))) +
  facet_wrap(~year) +
  scale_fill_viridis(trans = "sqrt")

plot_map + 
  geom_raster(data = mfle_q4_pred,
              aes(X*1000, Y*1000, fill = exp(est))) +
  facet_wrap(~year) +
  scale_fill_viridis(trans = "sqrt")
```

## Calculate spatial overlap indices

```{r}
all_pred_q1 <- mcod_s_q1_pred %>% mutate(small_cod = exp(est))

all_pred_q1 <- all_pred_q1 %>%
  mutate(large_cod = exp(mcod_l_q1_pred$est),
         fle = exp(mfle_q1_pred$est))

all_pred_q4 <- mcod_s_q4_pred %>% mutate(small_cod = exp(est))

all_pred_q4 <- all_pred_q4 %>%
  mutate(large_cod = exp(mcod_l_q4_pred$est),
         fle = exp(mfle_q4_pred$est))

all_pred <- bind_rows(all_pred_q1, all_pred_q4)

# Calculate biomass overlap
loc_collocspfn <- function(prey, pred) {
  p_prey <- prey/sum(prey, na.rm = T)
  p_pred <- pred/sum(pred, na.rm = T)
  (p_prey*p_pred)/(sqrt(sum(p_prey^2, na.rm = T))* sqrt(sum(p_pred^2, na.rm = T)))
}

loc_collocspfn_tot <- function(prey, pred) {
  p_prey <- prey/sum(prey, na.rm = T)
  p_pred <- pred/sum(pred, na.rm = T)
  sum((p_prey*p_pred))/(sqrt(sum(p_prey^2, na.rm = T))* sqrt(sum(p_pred^2, na.rm = T)))
}

all_pred <- all_pred %>% 
  group_by(year, quarter) %>% 
  mutate(scod_fle_ovr = loc_collocspfn(pred = small_cod, prey = fle),
         scod_fle_ovr_tot = loc_collocspfn_tot(pred = small_cod, prey = fle),
         lcod_fle_ovr = loc_collocspfn(pred = large_cod, prey = fle),
         lcod_fle_ovr_tot = loc_collocspfn_tot(pred = large_cod, prey = fle)) %>% 
  ungroup()
```

Plot

```{r}
plot_map_fc +
  geom_raster(data = all_pred %>% filter(quarter == 1),
              aes(x = X, y = Y, fill = scod_fle_ovr)) +
  scale_fill_viridis_c(trans = "sqrt", name = "small cod-flounder") +
  facet_wrap(~ year, ncol = 5) +
  theme(legend.text = element_text(angle = 90)) + 
  NULL

plot_map_fc +
  geom_raster(data = all_pred %>% filter(quarter == 4),
              aes(x = X, y = Y, fill = lcod_fle_ovr)) +
  scale_fill_viridis_c(trans = "sqrt", name = "large cod-flounder") +
  facet_wrap(~ year, ncol = 5) +
  theme(legend.text = element_text(angle = 90)) + 
  NULL

# In space for selected year
all_pred2 <- all_pred %>%
  filter(year %in% c(1995, 2015)) %>% 
  dplyr::select(X, Y, scod_fle_ovr, lcod_fle_ovr, quarter, year) %>% 
  pivot_longer(c(scod_fle_ovr, lcod_fle_ovr)) %>% 
  rename(overlap = name)

p1 <- plot_map_fc +
  geom_raster(data = filter(all_pred2, overlap == "scod_fle_ovr"),
              aes(x = X*1000, y = Y*1000, fill = value)) +
  scale_fill_viridis_c(trans = "sqrt", name = "Overlap") +
  facet_grid(year ~ quarter) +
  theme(legend.text = element_text(angle = 90)) + 
  ggtitle("Small cod : Flonder") +
  NULL

p2 <- plot_map_fc +
  geom_raster(data = filter(all_pred2, overlap == "lcod_fle_ovr"),
              aes(x = X*1000, y = Y*1000, fill = value)) +
  scale_fill_viridis_c(trans = "sqrt", name = "Overlap") +
  facet_grid(year ~ quarter) +
  theme(legend.text = element_text(angle = 90)) + 
  ggtitle("Large cod : Flonder") +
  NULL

p1 + p2

ggsave("figures/spatial_overlap.pdf", width = 22, height = 14, units = "cm")

# Over time
p5 <- all_pred %>% 
  distinct(year, quarter, .keep_all = TRUE) %>% 
  ggplot(aes(year, lcod_fle_ovr_tot, color = factor(quarter), fill = factor(quarter))) + 
  labs(color = "Quarter", x = "Year", y = "Overlap index") + 
  guides(fill = "none") +
  stat_smooth(method = "gam", formula = y~s(x, k = 3)) +
  ggtitle("Large cod : Flounder") +
  geom_point()

p6 <- all_pred %>% 
  distinct(year, quarter, .keep_all = TRUE) %>% 
  ggplot(aes(year, scod_fle_ovr_tot, color = factor(quarter), fill = factor(quarter))) + 
  labs(color = "Quarter", x = "Year", y = "Overlap index") + 
  guides(fill = "none") +
  stat_smooth(method = "gam", formula = y~s(x, k = 3)) +
  ggtitle("Small cod : Flounder") +
  geom_point()

(p5 | p6) + plot_annotation(tag_levels = "A") & theme(aspect.ratio = 1)
ggsave("figures/spatial_overlap_time.pdf", width = 20, height = 20, units = "cm")
```

## Conditional effects

```{r}
# Scale with respect to data!
nd_depth <- data.frame(depth = seq(min(cpue2$depth), max(cpue2$depth), length.out = 100)) %>% 
  mutate(depth_ct = depth - mean(cpue2$depth),
         depth_sq = depth_ct * depth_ct,
         depth_sq_sc = (depth_sq - mean(cpue2$depth_sq)) / sd(cpue2$depth_sq),
         depth_sc = (depth - mean(cpue2$depth)) / sd(cpue2$depth),
         temp_sq_sc = 0,
         temp_sc = 0,
         oxy_sc = 0,
         sal_sc = 0,
         year = 1999L,
         fyear = as.factor(1999),
         fsubstrate = "mud")

# Q1
margin_small_cod_pred_q1_depth <- predict(mcod_s_q1_space,
                                          newdata = nd_depth,
                                          se_fit = TRUE,
                                          re_form = NA) %>%
  mutate(species = "small_cod", quarter = 1)

margin_large_cod_pred_q1_depth <- predict(mcod_l_q1_space,
                                          newdata = nd_depth,
                                          se_fit = TRUE,
                                          re_form = NA) %>%
  mutate(species ="large_cod", quarter = 1)

margin_fle_pred_q1_depth <- predict(mfle_q1_space,
                                    newdata = nd_depth,
                                    se_fit = TRUE,
                                    re_form = NA) %>%
  mutate(species = "flounder", quarter = 1)

# Q4
margin_small_cod_pred_q4_depth <- predict(mcod_s_q4_space,
                                          newdata = nd_depth,
                                          se_fit = TRUE,
                                          re_form = NA) %>%
  mutate(species = "small_cod", quarter = 4)

margin_large_cod_pred_q4_depth <- predict(mcod_l_q4_space,
                                          newdata = nd_depth,
                                          se_fit = TRUE,
                                          re_form = NA) %>%
  mutate(species = "large_cod", quarter = 4)

margin_fle_pred_q4_depth <- predict(mfle_q4_space,
                                    newdata = nd_depth,
                                    se_fit = TRUE,
                                    re_form = NA) %>%
  mutate(species = "flounder", quarter = 4)

margins_depth <- bind_rows(margin_small_cod_pred_q1_depth,
                           margin_large_cod_pred_q1_depth,
                           margin_fle_pred_q1_depth,
                           margin_small_cod_pred_q4_depth,
                           margin_large_cod_pred_q4_depth,
                           margin_fle_pred_q4_depth) %>% 
    mutate(species = ifelse(species == "flounder", "Flounder", species),
           species = ifelse(species == "small_cod", "Small cod", species),
           species = ifelse(species == "large_cod", "Large cod", species))

# Temperature
nd_temp <- data.frame(temp = seq(min(cpue2$temp), max(cpue2$temp), length.out = 100)) %>% 
  mutate(temp_ct = temp - mean(cpue2$temp),
         temp_sq = temp_ct * temp_ct,
         temp_sq_sc = (temp_sq - mean(cpue2$temp_sq)) / sd(cpue2$temp_sq),
         temp_sc = (temp - mean(cpue2$temp)) / sd(cpue2$temp),
         depth_sq_sc = 0,
         depth_sc = 0,
         oxy_sc = 0,
         sal_sc = 0,
         year = 1999L,
         fyear = as.factor(1999),
         fsubstrate = "mud")

# Q1
margin_small_cod_pred_q1_temp <- predict(mcod_s_q1_space,
                                         newdata = nd_temp,
                                         se_fit = TRUE,
                                         re_form = NA) %>%
  mutate(species = "small_cod", quarter = 1)

margin_large_cod_pred_q1_temp <- predict(mcod_l_q1_space,
                                         newdata = nd_temp,
                                         se_fit = TRUE,
                                         re_form = NA) %>%
  mutate(species ="large_cod", quarter = 1)

margin_fle_pred_q1_temp <- predict(mfle_q1_space,
                                   newdata = nd_temp,
                                   se_fit = TRUE,
                                   re_form = NA) %>%
  mutate(species = "flounder", quarter = 1)

# Q4
margin_small_cod_pred_q4_temp <- predict(mcod_s_q4_space,
                                         newdata = nd_temp,
                                         se_fit = TRUE,
                                         re_form = NA) %>%
  mutate(species = "small_cod", quarter = 4)

margin_large_cod_pred_q4_temp <- predict(mcod_l_q4_space,
                                         newdata = nd_temp,
                                         se_fit = TRUE,
                                         re_form = NA) %>%
  mutate(species = "large_cod", quarter = 4)

margin_fle_pred_q4_temp <- predict(mfle_q4_space,
                                   newdata = nd_temp,
                                   se_fit = TRUE,
                                   re_form = NA) %>%
  mutate(species = "flounder", quarter = 4)

margins_temp <- bind_rows(margin_small_cod_pred_q1_temp,
                          margin_large_cod_pred_q1_temp,
                          margin_fle_pred_q1_temp,
                          margin_small_cod_pred_q4_temp,
                          margin_large_cod_pred_q4_temp,
                          margin_fle_pred_q4_temp) %>% 
    mutate(species = ifelse(species == "flounder", "Flounder", species),
           species = ifelse(species == "small_cod", "Small cod", species),
           species = ifelse(species == "large_cod", "Large cod", species))

# Plot!
p1 <- ggplot(margins_depth, 
             aes(depth, exp(est), ymin = exp(est) - 1.96 * exp(est_se), ymax = exp(est) + 1.96 * exp(est_se),
                 color = species, fill = species)) +
  geom_line() +
  facet_wrap(~quarter, scales = "free") +
  geom_ribbon(alpha = 0.4, color = NA) +
  coord_cartesian(xlim = c(10, 170)) +
  theme(aspect.ratio = 1) +
  labs(x = "Depth (m)", y = "Biomass density", color = "", fill = "") +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1)


p2 <- ggplot(margins_temp,
             aes(temp, exp(est), ymin = exp(est) - 1.96 * exp(est_se), ymax = exp(est) + 1.96 * exp(est_se),
                 color = species, fill = species)) +
  geom_line() +
  facet_wrap(~quarter, scales = "free") +
  geom_ribbon(alpha = 0.4, color = NA) +
  coord_cartesian(xlim = c(1, 14)) +
  theme(aspect.ratio = 1) +
  labs(x = "Temperature (°C)", y = "Biomass density", color = "", fill = "") +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1)

(p1 / p2) + plot_annotation(tag_levels = "A") + plot_layout(guides = "collect")

ggsave("figures/supp/conditional_effects.pdf", width = 20, height = 20, units = "cm")

# Scaled
p3 <- margins_temp %>% 
  ungroup() %>% 
  group_by(species, quarter) %>% 
  mutate(max_est = max(exp(est)),
         est_sc = exp(est) / max_est) %>% 
  ggplot(aes(temp, est_sc, color = species, fill = species)) +
  geom_line(size = 1.3) +
  facet_wrap(~quarter, scales = "free") +
  coord_cartesian(xlim = c(1, 14)) +
  theme(aspect.ratio = 1) +
  labs(x = "Temperature (°C)", y = "Scaled biomass density", color = "", fill = "") +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1)

p4 <- margins_depth %>% 
  ungroup() %>% 
  group_by(species, quarter) %>% 
  mutate(max_est = max(exp(est)),
         est_sc = exp(est) / max_est) %>% 
  ggplot(aes(depth, est_sc, color = species, fill = species)) +
  geom_line(size = 1.3) +
  facet_wrap(~quarter, scales = "free") +
  coord_cartesian(xlim = c(10, 170)) +
  theme(aspect.ratio = 1) +
  labs(x = "Depth (m)", y = "Scaled biomass density", color = "", fill = "") +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1)

(p3 / p4) + plot_annotation(tag_levels = "A") + plot_layout(guides = "collect")

ggsave("figures/conditional_effects.pdf", width = 20, height = 20, units = "cm")
```

## Weighted quantiles

```{r}
head(all_pred) %>% as.data.frame()

all_pred_sub <- all_pred %>%
  dplyr::select(small_cod, large_cod, fle, year, temp, oxy, sal, depth, quarter) %>% 
  pivot_longer(c(small_cod, large_cod, fle)) %>% 
  rename(Species = name, density = value) 

wm <- all_pred_sub %>%
  pivot_longer(c(temp, oxy, sal, depth)) %>% 
  mutate(name = ifelse(name == "temp", "Temperature (°C)", name),
         name = ifelse(name == "sal", "Salinity", name),
         name = ifelse(name == "depth", "Depth", name),
         name = ifelse(name == "oxy", "Oxygen (ml/L)", name)) %>% 
  group_by(year, quarter, Species, name) %>%
  summarise("Weighted median" = hutils::weighted_quantile(v = value, w = density, p = c(0.5)),
            "1st quartile" = hutils::weighted_quantile(v = value, w = density, p = c(0.25)),
            "3rd quartile" = hutils::weighted_quantile(v = value, w = density, p = c(0.75))) %>% 
  rename(env_var = name) %>% 
  mutate(Species = ifelse(Species == "fle", "Flounder", Species),
         Species = ifelse(Species == "large_cod", "Large cod", Species),
         Species = ifelse(Species == "small_cod", "Small cod", Species))

ggplot(wm, aes(year, `Weighted median`, color = Species, fill = Species)) +
  geom_line() + 
  ggh4x::facet_grid2(env_var ~ quarter, scales = "free_y", independent = "y") +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1)

ggplot(wm, aes(year, `Weighted median`, color = Species)) +
  geom_line(size = 0.8) + 
  labs(linetype = "Quarter", x = "Year") +
  ggh4x::facet_grid2(env_var ~ quarter, scales = "free_y", independent = "y") +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1)

ggsave("figures/weighted_quantiles.pdf", width = 20, height = 20, units = "cm")

# Scaled
wm %>% 
  group_by(Species, quarter, env_var) %>% 
  mutate(`Weighted median scaled` = `Weighted median` - mean(`Weighted median`)) %>% 
  ggplot(aes(year, `Weighted median scaled`, color = Species)) +
  geom_line(size = 0.8) + 
  labs(linetype = "Quarter", x = "Year") +
  ggh4x::facet_grid2(env_var ~ quarter, scales = "free_y", independent = "y") +
  scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
  scale_fill_brewer(palette = "Paired", name = "Species", direction = -1)

ggsave("figures/supp/weighted_quantiles_scaled.pdf", width = 20, height = 20, units = "cm")

# ggplot(wm, aes(year, Median, color = Species, fill = Species)) +
#   geom_ribbon(aes(ymin = `1st quartile`, ymax = `3rd quartile`), alpha = 0.4, color = NA) + 
#   facet_wrap(env_var ~ quarter, scales = "free", ncol = 2) + 
#   scale_color_brewer(palette = "Paired", name = "Species", direction = -1) +
#   scale_fill_brewer(palette = "Paired", name = "Species", direction = -1)
# 
# ggsave("figures/supp/weighted_quantiles_range.pdf", width = 20, height = 20, units = "cm")
```

## [Extra for bentfish - calculate biomass index per subdivision]
### Compare with Q4 from previous index
```{r calculate indexes, cache=TRUE}
cpue3 <- cpue2 %>%
  mutate(tot_cod = large_cod + small_cod) %>%
  filter(quarter == 4)

spde <- make_mesh(cpue3, xy_cols = c("X", "Y"),
                  n_knots = 200, 
                  type = "kmeans", seed = 42)

cod_ind <- sdmTMB(tot_cod ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                    temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                  data = cpue3,
                  mesh = spde,
                  family = tweedie(link = "log"),
                  spatiotemporal = "AR1",
                  spatial = "on",
                  time = "year",
                  reml = FALSE,
                  control = sdmTMBcontrol(newton_loops = 1))

fle_ind <- sdmTMB(flounder ~ 0 + fsubstrate + fyear + depth_sc + depth_sq_sc +
                    temp_sc + temp_sq_sc + oxy_sc + sal_sc,
                  data = cpue3,
                  mesh = spde,
                  family = tweedie(link = "log"),
                  spatiotemporal = "AR1",
                  spatial = "on",
                  time = "year",
                  reml = FALSE,
                  control = sdmTMBcontrol(newton_loops = 1))

sanity(cod_ind)
sanity(fle_ind)
```

```{r simpler models to match original index in cod condition, cache = TRUE}
# cod_ind2 <- sdmTMB(tot_cod ~ 0 + fyear + s(depth_sc),
#                   data = cpue3,
#                   mesh = spde,
#                   family = tweedie(link = "log"),
#                   spatiotemporal = "AR1",
#                   spatial = "on",
#                   time = "year",
#                   reml = FALSE,
#                   control = sdmTMBcontrol(newton_loops = 1))
# 
# fle_ind2 <- sdmTMB(flounder ~ 0 + fyear + s(depth_sc),
#                   data = cpue3,
#                   mesh = spde,
#                   family = tweedie(link = "log"),
#                   spatiotemporal = "AR1",
#                   spatial = "on",
#                   time = "year",
#                   reml = FALSE,
#                   control = sdmTMBcontrol(newton_loops = 1))
# 
# sanity(cod_ind2)
# sanity(fle_ind2)
```

Now try old data as well

```{r}
# d_old <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/cod_condition/master/data/for_analysis/mdat_cpue_q_1_4.csv")
# 
# # Filter to match the data I want to predict on
# d_old <- d_old %>%
#   filter(year > 1992 & year < 2020 & quarter == 4)
# 
# # Calculate standardized variables
# d_old <- d_old %>% 
#   mutate(depth_sc = (depth - mean(depth))/sd(depth),
#          X = X/1000,
#          Y = Y/1000,
#          year = as.integer(year),
#          fyear  = as.factor(year)) %>% 
#   drop_na(depth) %>% 
#   rename("density_cod" = "density") # to fit better with how flounder is named
# 
# nrow(d_old)
# nrow(cpue3)
# 
# # Plot comparison
# p1 <- ggplot() + 
#   geom_histogram(data = d_old, aes(density_cod, fill = "old"), alpha = 0.5) +
#   geom_histogram(data = cpue3, aes(tot_cod, fill = "new"), alpha = 0.5) + 
#   scale_y_continuous(trans = "log")
# 
# p2 <- ggplot() + 
#   geom_histogram(data = d_old, aes(density_fle, fill = "old"), alpha = 0.5) +
#   geom_histogram(data = cpue3, aes(flounder, fill = "new"), alpha = 0.5) + 
#   scale_y_continuous(trans = "log")
# 
# p1 + p2
```

```{r old data index, cache=TRUE}
# spde_old <- make_mesh(d_old, xy_cols = c("X", "Y"),
#                   n_knots = 200, 
#                   type = "kmeans", seed = 42)
# 
# cod_ind3 <- sdmTMB(density_cod ~ 0 + fyear + s(depth_sc),
#                   data = d_old,
#                   mesh = spde_old,
#                   family = tweedie(link = "log"),
#                   spatiotemporal = "AR1",
#                   spatial = "on",
#                   time = "year",
#                   reml = FALSE,
#                   control = sdmTMBcontrol(newton_loops = 1))
# 
# fle_ind3 <- sdmTMB(density_fle ~ 0 + fyear + s(depth_sc),
#                   data = d_old,
#                   mesh = spde_old,
#                   family = tweedie(link = "log"),
#                   spatiotemporal = "AR1",
#                   spatial = "on",
#                   time = "year",
#                   reml = FALSE,
#                   control = sdmTMBcontrol(newton_loops = 1))
# 
# sanity(cod_ind3)
# sanity(fle_ind3)
```

```{r index for bentfish, cache=TRUE}
### Cod
# SD 24
preds_cod24_sim <- predict(cod_ind, newdata = filter(pred_grid, sub_div == 24), nsim = 100)

# SD 25
preds_cod25_sim <- predict(cod_ind, newdata = filter(pred_grid, sub_div == 25), nsim = 100)

# SD 26
preds_cod26_sim <- predict(cod_ind, newdata = filter(pred_grid, sub_div == 26), nsim = 100)

# SD 27
preds_cod27_sim <- predict(cod_ind, newdata = filter(pred_grid, sub_div == 27), nsim = 100)

# SD 28
preds_cod28_sim <- predict(cod_ind, newdata = filter(pred_grid, sub_div == 28), nsim = 100)

# Now calculate the CPUE index (average)
index24_cod_sim <- get_index_sims(preds_cod24_sim, area = rep(4*4, nrow(preds_cod24_sim)))
index25_cod_sim <- get_index_sims(preds_cod25_sim, area = rep(4*4, nrow(preds_cod25_sim)))
index26_cod_sim <- get_index_sims(preds_cod26_sim, area = rep(4*4, nrow(preds_cod26_sim)))
index27_cod_sim <- get_index_sims(preds_cod27_sim, area = rep(4*4, nrow(preds_cod27_sim)))
index28_cod_sim <- get_index_sims(preds_cod28_sim, area = rep(4*4, nrow(preds_cod28_sim)))

# Add some columns
index24_cod_sim <- index24_cod_sim %>% mutate(sub_div = "24", species = "cod")
index25_cod_sim <- index25_cod_sim %>% mutate(sub_div = "25", species = "cod")
index26_cod_sim <- index26_cod_sim %>% mutate(sub_div = "26", species = "cod")
index27_cod_sim <- index27_cod_sim %>% mutate(sub_div = "27", species = "cod")
index28_cod_sim <- index28_cod_sim %>% mutate(sub_div = "28", species = "cod")


### Flounder
# SD 24
preds_fle24_sim <- predict(fle_ind, newdata = filter(pred_grid, sub_div == 24), nsim = 100)

# SD 25
preds_fle25_sim <- predict(fle_ind, newdata = filter(pred_grid, sub_div == 25), nsim = 100)

# SD 26
preds_fle26_sim <- predict(fle_ind, newdata = filter(pred_grid, sub_div == 26), nsim = 100)

# SD 27
preds_fle27_sim <- predict(fle_ind, newdata = filter(pred_grid, sub_div == 27), nsim = 100)

# SD 28
preds_fle28_sim <- predict(fle_ind, newdata = filter(pred_grid, sub_div == 28), nsim = 100)

# Now calculate the CPUE index (average)
index24_fle_sim <- get_index_sims(preds_fle24_sim, area = rep(4*4, nrow(preds_fle24_sim)))
index25_fle_sim <- get_index_sims(preds_fle25_sim, area = rep(4*4, nrow(preds_fle25_sim)))
index26_fle_sim <- get_index_sims(preds_fle26_sim, area = rep(4*4, nrow(preds_fle26_sim)))
index27_fle_sim <- get_index_sims(preds_fle27_sim, area = rep(4*4, nrow(preds_fle27_sim)))
index28_fle_sim <- get_index_sims(preds_fle28_sim, area = rep(4*4, nrow(preds_fle28_sim)))

# Add some columns
index24_fle_sim <- index24_fle_sim %>% mutate(sub_div = "24", species = "fle")
index25_fle_sim <- index25_fle_sim %>% mutate(sub_div = "25", species = "fle")
index26_fle_sim <- index26_fle_sim %>% mutate(sub_div = "26", species = "fle")
index27_fle_sim <- index27_fle_sim %>% mutate(sub_div = "27", species = "fle")
index28_fle_sim <- index28_fle_sim %>% mutate(sub_div = "28", species = "fle")

div_index_sim <- bind_rows(index24_cod_sim,
                           index25_cod_sim,
                           index26_cod_sim,
                           index27_cod_sim,
                           index28_cod_sim,
                           index24_fle_sim,
                           index25_fle_sim,
                           index26_fle_sim,
                           index27_fle_sim,
                           index28_fle_sim) %>% 
  mutate(est_t = est/1000, lwr_t = lwr/1000, upr_t = upr/1000) # convert to tonnes 
```

Plot the index and save as csv

```{r plot and save index}
# # First compare with previous index:
# cod_fle_index_old <- read.csv("/Users/maxlindmark/Dropbox/Max work/R/cod_condition/output/cod_fle_index.csv") %>% 
#   mutate(sub_div = as.character(sub_div)) %>% 
#   filter(sub_div %in% c("25", "28"))
# 
# index_comp <- bind_rows(cod_fle_index_old %>% mutate(source = "cod_condition"),
#                         div_index_sim %>% mutate(source = "cod_interactions"))
# 
# ggplot(index_comp, aes(year, est_t, color = source, fill = source)) +
#   facet_wrap(sub_div ~ species, scales = "free") +
#   geom_line() +
#   geom_ribbon(aes(year, ymin = lwr_t, ymax = upr_t), alpha = 0.2, color = NA)
# 
# 
# ## If it isn't the same with the data, plot pred grids against each other

ggplot(div_index_sim, aes(year, est_t, color = sub_div)) +
  geom_line() +
  facet_wrap(~species, scales = "free") +
  geom_ribbon(aes(year, ymin = lwr_t, ymax = upr_t, fill = sub_div), alpha = 0.2, color = NA) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2", name = "ICES subdivision") +
  guides(color = "none") + 
  labs(x = "Year", y = "Tonnes", fill = "Sub Divisions") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.key.height = unit(0.2, "cm"),
        legend.key.width = unit(0.2, "cm"),
        legend.background = element_blank(),
        plot.margin = unit(c(0, 0.25, 0.15, 0), "cm")) +
  NULL

div_index_sim %>% 
  filter(sub_div %in% c(25, 28)) %>% 
  ggplot(aes(year, est_t/1000, color = species, fill = species)) +
  geom_line() +
  facet_wrap(~sub_div, scales = "free", ncol = 1) +
  geom_ribbon(aes(year, ymin = lwr_t/1000, ymax = upr_t/1000), alpha = 0.2, color = NA) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2", name = "Species") +
  guides(color = "none") + 
  labs(x = "Year", y = "Tonnes", fill = "Sub Divisions") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.key.height = unit(0.2, "cm"),
        legend.key.width = unit(0.2, "cm"),
        legend.background = element_blank(),
        plot.margin = unit(c(0, 0.25, 0.15, 0), "cm")) +
  NULL

ggplot(div_index_sim, aes(year, est_t, color = sub_div)) +
  geom_line() +
  facet_wrap(~species, scales = "free") +
  #geom_ribbon(aes(year, ymin = lwr_t, ymax = upr_t, fill = sub_div), alpha = 0.2) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2", name = "ICES subdivision") +
  guides(color = "none") + 
  labs(x = "Year", y = "Tonnes", fill = "Sub Divisions") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.key.height = unit(0.2, "cm"),
        legend.key.width = unit(0.2, "cm"),
        legend.background = element_blank(),
        plot.margin = unit(c(0, 0.25, 0.15, 0), "cm")) +
  NULL

ggplot(div_index_sim, aes(year, est_t, color = species)) +
  geom_line() +
  facet_wrap(~sub_div, scales = "free") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2", name = "ICES subdivision") +
  labs(x = "Year", y = "Tonnes", fill = "Sub Divisions") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.key.height = unit(0.2, "cm"),
        legend.key.width = unit(0.2, "cm"),
        legend.background = element_blank(),
        plot.margin = unit(c(0, 0.25, 0.15, 0), "cm")) +
  NULL

write.csv(div_index_sim, "output/cod_fle_index.csv")
```


